<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—ç»è¥æ—¥æŠ¥ | NEXUS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #09090b; color: #fafafa; font-family: 'Noto Sans SC', sans-serif; font-size: 12px; }
        
        .card { background: #18181b; border: 1px solid #27272a; border-radius: 8px; }
        .kpi-card { padding: 10px 12px; border-left: 3px solid; }
        .kpi-card.blue { border-color: #3b82f6; }
        .kpi-card.green { border-color: #22c55e; }
        .kpi-card.amber { border-color: #f59e0b; }
        .kpi-card.purple { border-color: #a855f7; }
        .kpi-value { font-size: 1.1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        
        .tag { padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: 600; }
        .tag-green { background: rgba(34,197,94,0.15); color: #22c55e; }
        .tag-red { background: rgba(239,68,68,0.15); color: #ef4444; }
        
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { padding: 5px 3px; text-align: left; border-bottom: 1px solid #27272a; }
        th { color: #71717a; font-size: 9px; }
        
        .sidebar { width: 180px; transition: width 0.2s; }
        .sidebar.collapsed { width: 40px; }
        .sidebar.collapsed .sidebar-content { display: none; }
        .sidebar.collapsed .sidebar-toggle i { transform: rotate(180deg); }
        
        .history-item { padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .history-item:hover { background: #27272a; }
        .history-item.active { background: #27272a; border-left: 2px solid #3b82f6; }
        .month-content { max-height: 0; overflow: hidden; transition: max-height 0.2s; }
        .month-content.expanded { max-height: 300px; }
        
        #toast-container { position: fixed; top: 12px; right: 12px; z-index: 9999; }
        .toast { padding: 6px 12px; border-radius: 4px; font-size: 11px; margin-bottom: 4px; animation: slideIn 0.2s; }
        .toast-success { background: #166534; }
        .toast-error { background: #991b1b; }
        .toast-info { background: #1e40af; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        
        .modal-backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        /* AI åˆ†ææ ·å¼ */
        #ai-analysis { font-size: 11px; line-height: 1.6; }
        #ai-analysis .section-title { color: #60a5fa; font-size: 11px; font-weight: 600; margin: 10px 0 6px 0; display: flex; align-items: center; gap: 6px; }
        #ai-analysis .section-title:first-child { margin-top: 0; }
        #ai-analysis p { color: #d4d4d8; margin: 4px 0; }
        #ai-analysis strong { color: #f4f4f5; }
        #ai-analysis .highlight-good { color: #4ade80; }
        #ai-analysis .highlight-bad { color: #f87171; }
        #ai-analysis .data-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #27272a; }
        #ai-analysis .data-row:last-child { border-bottom: none; }
        #ai-analysis .sub-item { padding-left: 12px; font-size: 10px; color: #a1a1aa; }
        
        .ai-loading .spinner { width: 14px; height: 14px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .deep-summary { background: #1f1f23; border-radius: 6px; padding: 12px; margin-top: 12px; font-size: 11px; }
        .deep-summary .good { color: #4ade80; }
        .deep-summary .bad { color: #f87171; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="toast-container"></div>

    <div class="flex min-h-screen">
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class="sidebar border-r border-zinc-800 p-2 flex flex-col bg-[#0c0c0e]">
            <button onclick="toggleSidebar()" class="sidebar-toggle w-full flex items-center justify-center py-1.5 mb-2 text-zinc-500 hover:text-white text-xs">
                <i class="fa-solid fa-chevron-left transition-transform"></i>
            </button>
            <div class="sidebar-content flex flex-col flex-1">
                <div class="flex items-center gap-2 mb-3 px-1">
                    <div class="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <i class="fa-solid fa-chart-line text-white text-[10px]"></i>
                    </div>
                    <span class="font-semibold text-white text-xs">NEXUS</span>
                </div>
                <label class="block mb-3">
                    <div class="w-full py-1.5 bg-blue-600 hover:bg-blue-500 rounded cursor-pointer text-center text-[10px] font-medium">
                        <i class="fa-solid fa-upload mr-1"></i>ä¸Šä¼ æŠ¥è¡¨
                    </div>
                    <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" class="hidden">
                </label>
                <div class="flex items-center justify-between mb-1 px-1">
                    <span class="text-[9px] text-zinc-500 uppercase">å†å²</span>
                    <span class="text-[9px] text-zinc-600" id="history-count">0</span>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto"></div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="flex-1 p-2.5 overflow-y-auto">
            <!-- é¡¶éƒ¨ -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span id="current-date" class="text-base font-semibold text-white">--</span>
                    <span id="data-status" class="tag tag-red">æ— æ•°æ®</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <button onclick="refreshFromGitHub()" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-[10px] text-zinc-400"><i class="fa-solid fa-sync"></i></button>
                    <button id="save-btn" onclick="saveToGitHub()" disabled class="px-2.5 py-1 bg-green-600 hover:bg-green-500 disabled:opacity-40 rounded text-[10px] font-medium"><i class="fa-solid fa-cloud-arrow-up mr-1"></i>ä¿å­˜</button>
                    <button onclick="openSettingsModal()" class="w-6 h-6 bg-zinc-800 hover:bg-zinc-700 rounded flex items-center justify-center text-zinc-400 text-[10px]"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>

            <!-- KPI -->
            <div class="grid grid-cols-4 gap-2 mb-2">
                <div class="card kpi-card blue">
                    <p class="text-[9px] text-zinc-500">æ€»è¥æ”¶ Total Revenue</p>
                    <p id="kpi-revenue" class="kpi-value text-white">--</p>
                    <p class="text-[9px] text-zinc-500">é¢„ç®— <span id="kpi-revenue-bud">--</span> <span id="kpi-revenue-tag" class="tag">--</span></p>
                </div>
                <div class="card kpi-card green">
                    <p class="text-[9px] text-zinc-500">å‡ºç§Ÿç‡ Occupancy</p>
                    <p id="kpi-occ" class="kpi-value text-white">--</p>
                    <p class="text-[9px] text-zinc-500">å”®æˆ¿ <span id="kpi-sold">--</span>/260</p>
                </div>
                <div class="card kpi-card amber">
                    <p class="text-[9px] text-zinc-500">ADR å¹³å‡æˆ¿ä»·</p>
                    <p id="kpi-adr" class="kpi-value text-white">--</p>
                    <p class="text-[9px] text-zinc-500">é¢„ç®— <span id="kpi-adr-bud">--</span></p>
                </div>
                <div class="card kpi-card purple">
                    <p class="text-[9px] text-zinc-500">RevPAR æ¯æˆ¿æ”¶ç›Š</p>
                    <p id="kpi-revpar" class="kpi-value text-white">--</p>
                    <p class="text-[9px] text-zinc-500">é¢„ç®— <span id="kpi-revpar-bud">--</span></p>
                </div>
            </div>

            <!-- ä¸»åŒºåŸŸ -->
            <div class="grid grid-cols-12 gap-2 mb-2">
                <!-- å·¦ä¾§ -->
                <div class="col-span-5 flex flex-col gap-2">
                    <div class="card p-2">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-medium text-zinc-300"><i class="fa-solid fa-layer-group text-blue-400 mr-1"></i>éƒ¨é—¨æ¦‚è§ˆ</span>
                            <button onclick="openDeepDive()" class="text-[9px] text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                <i class="fa-solid fa-table-list"></i>æŸ¥çœ‹è¯¦ç»†æ•°æ®
                            </button>
                        </div>
                        <table>
                            <thead><tr><th>éƒ¨é—¨</th><th>å®é™…</th><th>é¢„ç®—</th><th>å·®é¢</th><th>å®Œæˆ</th></tr></thead>
                            <tbody id="dept-table-body"><tr><td colspan="5" class="text-center text-zinc-600 py-2">--</td></tr></tbody>
                        </table>
                    </div>
                    <div class="card p-2">
                        <span class="text-[10px] font-medium text-zinc-300"><i class="fa-solid fa-chart-bar text-blue-400 mr-1"></i>è¥æ”¶å¯¹æ¯”</span>
                        <div id="main-chart" style="height:120px;"></div>
                    </div>
                    <div class="card p-2">
                        <span class="text-[10px] font-medium text-zinc-300"><i class="fa-solid fa-chart-line text-amber-400 mr-1"></i>å†å²è¶‹åŠ¿</span>
                        <div id="trend-chart" style="height:110px;"></div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šAIåˆ†æ -->
                <div class="col-span-7">
                    <div class="card p-3 h-full">
                        <div class="flex items-center justify-between mb-2 pb-2 border-b border-zinc-800">
                            <span class="text-[11px] font-medium text-white"><i class="fa-solid fa-robot text-purple-400 mr-1"></i>AI ç»è¥åˆ†æ</span>
                            <span id="ai-update-time" class="text-[9px] text-zinc-600">--</span>
                        </div>
                        <div id="ai-analysis" class="overflow-y-auto pr-1" style="max-height: 380px;">
                            <div class="flex items-center justify-center py-8 text-zinc-600 text-xs">
                                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ä¸Šä¼ æ•°æ®åè‡ªåŠ¨åˆ†æ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center">
        <div class="bg-zinc-900 rounded-lg p-4 w-full max-w-xl border border-zinc-700">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-white"><i class="fa-solid fa-gear text-blue-400 mr-2"></i>è®¾ç½®</h3>
                <button onclick="closeModal('settings-modal')" class="text-zinc-500 hover:text-white text-sm"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div>
                    <label class="text-[9px] text-zinc-500 uppercase">Webhook URL</label>
                    <input type="text" id="settings-webhook" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-[10px] font-mono text-zinc-300">
                </div>
                <div>
                    <label class="text-[9px] text-zinc-500 uppercase">GitHub ä»“åº“ (owner/repo)</label>
                    <input type="text" id="settings-github-repo" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-[10px] font-mono text-zinc-300">
                </div>
            </div>
            <div class="mb-3">
                <label class="text-[9px] text-zinc-500 uppercase">AI åˆ†ææç¤ºè¯</label>
                <textarea id="settings-ai-prompt" rows="14" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-[10px] font-mono text-zinc-300 leading-relaxed"></textarea>
            </div>
            <div class="flex justify-between">
                <button onclick="resetPrompt()" class="px-2 py-1 text-zinc-400 hover:text-white text-[10px]"><i class="fa-solid fa-rotate-left mr-1"></i>æ¢å¤é»˜è®¤</button>
                <div class="flex gap-2">
                    <button onclick="closeModal('settings-modal')" class="px-2 py-1 text-zinc-400 text-[10px]">å–æ¶ˆ</button>
                    <button onclick="saveSettings()" class="px-3 py-1 bg-blue-600 text-white rounded text-[10px] font-medium">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·±åº¦åˆ†æ -->
    <div id="deep-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex flex-col">
        <div class="h-10 px-3 border-b border-zinc-800 flex items-center justify-between bg-[#0c0c0e]">
            <div class="flex items-center gap-2">
                <button onclick="closeModal('deep-modal')" class="text-zinc-400 hover:text-white text-xs"><i class="fa-solid fa-arrow-left mr-2"></i>è¿”å›</button>
                <span class="text-xs font-medium text-white">æ·±åº¦åˆ†æ - æ”¶å…¥æ˜ç»†</span>
            </div>
            <div class="flex gap-1">
                <button id="deep-tab-room" onclick="switchDeepTab('room')" class="px-3 py-1 rounded text-[10px] bg-zinc-700 text-white">å®¢æˆ¿æ”¶å…¥</button>
                <button id="deep-tab-fb" onclick="switchDeepTab('fb')" class="px-3 py-1 rounded text-[10px] text-zinc-400">é¤é¥®æ”¶å…¥</button>
                <button id="deep-tab-other" onclick="switchDeepTab('other')" class="px-3 py-1 rounded text-[10px] text-zinc-400">å…¶ä»–æ”¶å…¥</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-3 bg-[#09090b]">
            <div class="max-w-5xl mx-auto">
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-3">
                        <h4 class="text-xs font-medium text-zinc-300 mb-2"><i class="fa-solid fa-table text-blue-400 mr-1"></i>æ”¶å…¥æ˜ç»†è¡¨</h4>
                        <div class="overflow-auto max-h-72"><table><thead id="deep-table-head"></thead><tbody id="deep-table-body"></tbody></table></div>
                    </div>
                    <div class="card p-3">
                        <h4 class="text-xs font-medium text-zinc-300 mb-2"><i class="fa-solid fa-chart-bar text-blue-400 mr-1"></i>æ”¶å…¥æ’è¡Œå‰10å</h4>
                        <div id="deep-chart" style="height:220px;"></div>
                    </div>
                </div>
                <div class="deep-summary" id="deep-summary">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-lightbulb text-amber-400"></i>
                        <span class="text-xs font-medium text-white">æ•°æ®åˆ†ææ‘˜è¦</span>
                    </div>
                    <div id="deep-summary-content" class="text-zinc-400">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æç¤ºè¯ - ç›´æ¥å‘Šè¯‰AIå·²è®¡ç®—å¥½çš„æ•°æ®ï¼Œä¸è®©å®ƒè‡ªå·±ç®—
        const DEFAULT_AI_PROMPT = `ä½ æ˜¯é…’åº—ç»è¥åˆ†æå¸ˆã€‚ä»¥ä¸‹æ˜¯å·²ç»è®¡ç®—å¥½çš„ç»è¥æ•°æ®ï¼Œè¯·ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®è¿›è¡Œåˆ†æï¼Œä¸è¦è‡ªå·±é‡æ–°è®¡ç®—ã€‚

ã€ä»Šæ—¥ç»è¥æ¦‚å†µ - ä»¥ä¸‹æ•°æ®å·²è®¡ç®—å¥½ï¼Œè¯·ç›´æ¥ä½¿ç”¨ã€‘
æ—¥æœŸï¼š{date}
ä»Šæ—¥ç›ˆäºï¼š{profit_status}{profit_amount}ä¸‡å…ƒ
- å®¢æˆ¿æ”¶å…¥å·®é¢ï¼š{room_diff}ï¼ˆ{room_status}ï¼‰
- é¤é¥®æ”¶å…¥å·®é¢ï¼š{fb_diff}ï¼ˆ{fb_status}ï¼‰  
- å…¶ä»–æ”¶å…¥å·®é¢ï¼š{other_diff}ï¼ˆ{other_status}ï¼‰

å…¥ä½ç‡ï¼š{occupancy}%ï¼ˆé¢„ç®—{occ_bud}%ï¼Œ{occ_status}ï¼‰
å”®æˆ¿ï¼š{roomsSold}é—´ï¼ˆé¢„ç®—{rooms_bud}é—´ï¼‰
ADRå¹³å‡æˆ¿ä»·ï¼šÂ¥{adr}
RevPARï¼šÂ¥{revpar}

ã€å„é¡¹æ”¶å…¥æ˜ç»†ã€‘
{details}

ã€åˆ†æè¦æ±‚ã€‘
è¯·ç”¨HTMLæ ¼å¼è¾“å‡ºåˆ†ææŠ¥å‘Šï¼Œç¦æ­¢ä½¿ç”¨##ã€###ã€**ç­‰Markdownæ ¼å¼ã€‚

1. ä»Šæ—¥ç›ˆäºéƒ¨åˆ†ï¼šç›´æ¥ä½¿ç”¨ä¸Šé¢æä¾›çš„ç›ˆäºæ•°æ®ï¼Œåˆ†ææ¯ä¸ªæ¿å—å·®é¢çš„åŸå› 
2. å®¢æˆ¿åˆ†æï¼šæ ¹æ®æ˜ç»†æ•°æ®ï¼ŒæŒ‡å‡ºå“ªäº›æ¸ é“/æˆ¿å‹è¡¨ç°å¥½ï¼ˆå®Œæˆç‡>100%ï¼‰ï¼Œå“ªäº›å·®ï¼ˆ<80%ï¼‰
3. é¤é¥®åˆ†æï¼šæ ¹æ®æ˜ç»†æ•°æ®ï¼ŒæŒ‡å‡ºå“ªäº›é¤å…è¡¨ç°å¥½ï¼Œå“ªäº›å·®
4. é£é™©é¢„è­¦ï¼šæŒ‡å‡ºéœ€è¦é‡ç‚¹å…³æ³¨çš„é—®é¢˜
5. æœˆåº¦é¢„æµ‹ï¼šæœ¬æœˆç¬¬{day}å¤©ï¼Œæ—¶é—´è¿›åº¦{time_progress}%

è¾“å‡ºæ ¼å¼ï¼š
<div class="section-title">ğŸ’° ä»Šæ—¥ç›ˆäº</div>
<p><strong>{ç›´æ¥ç”¨æˆ‘ç»™çš„ç›ˆäºæ•°æ®}</strong></p>
<div class="data-row"><span>å®¢æˆ¿</span><span class="{highlight-goodæˆ–highlight-bad}">{ç›´æ¥ç”¨æˆ‘ç»™çš„å·®é¢}</span></div>
<p class="sub-item">â†’ {åˆ†æåŸå› ï¼Œå¼•ç”¨å…·ä½“æ˜ç»†é¡¹ç›®}</p>
...åç»­æ¿å—åŒç†

é‡è¦ï¼šæ‰€æœ‰æ•°å­—å¿…é¡»ä½¿ç”¨æˆ‘æä¾›çš„æ•°æ®ï¼Œä¸è¦è‡ªå·±è®¡ç®—ï¼`;

        const STATE = {
            currentData: null, historyIndex: [], historyData: {}, charts: {}, totalRooms: 260,
            webhookUrl: localStorage.getItem('nexus_webhook_url') || 'https://n8n-fzlhzvbn.ap-northeast-1.clawcloudrun.com/webhook/hotel-save',
            github: { owner: 'QIAN123-KIWI', repo: 'hotel-daily-reportV3', branch: 'main', dataPath: 'data' },
            qianwen: { apiKey: 'sk-d8f9d80c5d154e5fa8ce9413560ccfe8', model: 'qwen-max', endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions' },
            aiPrompt: localStorage.getItem('nexus_ai_prompt') || DEFAULT_AI_PROMPT,
            sidebarCollapsed: localStorage.getItem('nexus_sidebar_collapsed') === 'true'
        };

        // å·¥å…·å‡½æ•°
        function toggleSidebar() {
            const s = document.getElementById('sidebar'); s.classList.toggle('collapsed');
            STATE.sidebarCollapsed = s.classList.contains('collapsed');
            localStorage.setItem('nexus_sidebar_collapsed', STATE.sidebarCollapsed);
            setTimeout(() => Object.values(STATE.charts).forEach(c => c?.resize()), 250);
        }
        function showToast(m, t = 'info') { const c = document.getElementById('toast-container'), e = document.createElement('div'); e.className = `toast toast-${t}`; e.innerHTML = m; c.appendChild(e); setTimeout(() => { e.style.opacity = '0'; setTimeout(() => e.remove(), 200); }, 2500); }
        function openSettingsModal() { document.getElementById('settings-webhook').value = STATE.webhookUrl; document.getElementById('settings-github-repo').value = `${STATE.github.owner}/${STATE.github.repo}`; document.getElementById('settings-ai-prompt').value = STATE.aiPrompt; document.getElementById('settings-modal').classList.remove('hidden'); }
        function openDeepDive() { document.getElementById('deep-modal').classList.remove('hidden'); switchDeepTab('room'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function resetPrompt() { document.getElementById('settings-ai-prompt').value = DEFAULT_AI_PROMPT; }
        function saveSettings() {
            STATE.webhookUrl = document.getElementById('settings-webhook').value.trim();
            const r = document.getElementById('settings-github-repo').value.trim().split('/');
            if (r.length === 2) { STATE.github.owner = r[0]; STATE.github.repo = r[1]; }
            STATE.aiPrompt = document.getElementById('settings-ai-prompt').value.trim() || DEFAULT_AI_PROMPT;
            localStorage.setItem('nexus_webhook_url', STATE.webhookUrl);
            localStorage.setItem('nexus_ai_prompt', STATE.aiPrompt);
            closeModal('settings-modal'); showToast('âœ“ å·²ä¿å­˜', 'success'); refreshFromGitHub();
        }

        // äº‘ç«¯
        async function saveToGitHub() {
            if (!STATE.currentData) return showToast('è¯·å…ˆä¸Šä¼ ', 'error');
            const btn = document.getElementById('save-btn'); btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            try { await fetch(STATE.webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(STATE.currentData) }); showToast('âœ“ å·²ä¿å­˜', 'success'); setTimeout(refreshFromGitHub, 2000); }
            catch { showToast('ä¿å­˜å¤±è´¥', 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-1"></i>ä¿å­˜'; }
        }
        async function refreshFromGitHub() {
            try { 
                const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/index.json?t=${Date.now()}`); 
                if (!res.ok) throw new Error(); 
                STATE.historyIndex = await res.json(); 
                renderHistoryList(); 
                if (STATE.historyIndex.length) { 
                    const s = [...STATE.historyIndex].sort((a, b) => b.date.localeCompare(a.date)); 
                    await loadDayData(s[0].date); 
                } 
                await loadTrendData(); 
            } catch (e) { console.error(e); }
        }
        async function loadDayData(date) {
            if (STATE.historyData[date]) { STATE.currentData = STATE.historyData[date]; renderDashboard(STATE.currentData); return; }
            try { const [y, m] = date.split('-'); const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/${y}/${m}/${date}.json?t=${Date.now()}`); if (!res.ok) throw new Error(); const d = await res.json(); STATE.historyData[date] = d; STATE.currentData = d; renderDashboard(d); document.querySelectorAll('.history-item').forEach(el => el.classList.toggle('active', el.dataset.date === date)); document.getElementById('save-btn').disabled = false; } catch {}
        }
        async function loadTrendData() {
            const s = [...STATE.historyIndex].sort((a, b) => a.date.localeCompare(b.date)).slice(-30), td = [];
            for (const i of s) { 
                if (STATE.historyData[i.date]) td.push(STATE.historyData[i.date]); 
                else try { const [y, m] = i.date.split('-'); const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/${y}/${m}/${i.date}.json`); if (res.ok) { const d = await res.json(); STATE.historyData[i.date] = d; td.push(d); } } catch {} 
            }
            renderTrendChart(td);
        }

        // å†å²åˆ—è¡¨
        function renderHistoryList() {
            const c = document.getElementById('history-list'); document.getElementById('history-count').innerText = STATE.historyIndex.length;
            if (!STATE.historyIndex.length) { c.innerHTML = '<div class="text-center py-4 text-zinc-600 text-[10px]">æš‚æ— æ•°æ®</div>'; return; }
            const g = {}; STATE.historyIndex.forEach(i => { const k = i.date.slice(0, 7); if (!g[k]) g[k] = []; g[k].push(i); });
            let h = ''; Object.entries(g).sort((a, b) => b[0].localeCompare(a[0])).forEach(([m, items], idx) => {
                items.sort((a, b) => b.date.localeCompare(a.date));
                h += `<div class="mb-1"><div onclick="toggleMonth(this)" class="flex justify-between p-1 rounded cursor-pointer hover:bg-zinc-800 text-[10px] text-zinc-400"><span><i class="fa-solid fa-chevron-right mr-1 transition-transform ${idx === 0 ? 'rotate-90' : ''}" style="font-size:7px"></i>${m}</span><span class="text-zinc-600">${items.length}</span></div><div class="month-content ${idx === 0 ? 'expanded' : ''}">${items.map(i => `<div class="history-item flex justify-between" data-date="${i.date}" onclick="loadDayData('${i.date}')"><span class="text-zinc-300">${i.date.slice(8)}æ—¥</span><span class="${(i.variance || 0) >= 0 ? 'text-green-400' : 'text-red-400'} font-mono text-[10px]">${(i.variance || 0) >= 0 ? '+' : ''}${((i.variance || 0) * 100).toFixed(1)}%</span></div>`).join('')}</div></div>`;
            }); c.innerHTML = h;
        }
        function toggleMonth(h) { h.nextElementSibling.classList.toggle('expanded'); h.querySelector('i').classList.toggle('rotate-90'); }

        // Excel è§£æ
        function handleFileUpload(e) {
            const f = e.target.files[0]; if (!f) return;
            const fn = f.name.replace(/\.(xlsx|xls|csv)$/i, ''); let dateFromFn = null;
            const m1 = fn.match(/(\d{4})[-._](\d{1,2})[-._](\d{1,2})/); if (m1) dateFromFn = `${m1[1]}-${m1[2].padStart(2,'0')}-${m1[3].padStart(2,'0')}`;
            else { const m2 = fn.match(/(\d{1,2})[-._](\d{1,2})/); if (m2) dateFromFn = `${new Date().getFullYear()}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; }
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' }), rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }), parsed = parseExcelData(rows);
                if (dateFromFn) { parsed.date = dateFromFn; parsed.weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(dateFromFn).getDay()]; }
                STATE.currentData = parsed; renderDashboard(parsed); document.getElementById('save-btn').disabled = false; showToast(`âœ“ ${parsed.date}`, 'success'); generateAIAnalysis();
            };
            reader.readAsArrayBuffer(f); e.target.value = '';
        }

        function parseExcelData(rows) {
            let d = { date: new Date().toISOString().split('T')[0], weekday: '', rows: [], roomsSold: 0, roomsBud: 0, occupancy: 0, occBud: 0, adr: 0, adrBud: 0, revpar: 0, revparBud: 0, totals: {} };
            const num = v => v ? parseFloat(String(v).replace(/[Â¥,%]/g, '')) || 0 : 0;
            
            rows.forEach(r => {
                if (!r[0]) return; 
                const n = String(r[0]).trim();
                
                if (n.includes('Date') || n.includes('æ—¥æœŸ')) { 
                    const m = r.join(' ').match(/(\d{1,2})\/(\w+)\/(\d{4})/); 
                    if (m) { const mm = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'}; d.date = `${m[3]}-${mm[m[2]]||m[2]}-${m[1].padStart(2,'0')}`; d.weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(d.date).getDay()]; } 
                }
                
                if (n.includes('Total room Revenue') || n.includes('æ€»æˆ¿æ”¶å…¥')) d.totals.room = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('F&B Total') || n.includes('é¤é¥®æ”¶å…¥åˆè®¡')) d.totals.fb = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('Total Hotel Revenue') || n.includes('é…’åº—æ”¶å…¥åˆè®¡')) d.totals.hotel = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('Total Other Operating') || n.includes('å…¶ä»–ç»è¥æ”¶å…¥åˆè®¡')) d.totals.other = { act: num(r[6]), bud: num(r[7]) };
                
                if (n.includes('Occupied Rooms') || n.includes('å·²å‡ºç§Ÿæˆ¿æ•°')) { d.roomsSold = num(r[6]); d.roomsBud = num(r[7]); }
                if (n.includes('Paid Occupancy') || n.includes('å®¢æˆ¿ä½æˆ¿ç‡')) { d.occupancy = num(r[6]); d.occBud = num(r[7]); }
                if (n.includes('Paid Average Room Rate') || (n.includes('å¹³å‡æˆ¿ä»·') && !n.includes('å¯å‡ºç§Ÿ') && !n.includes('Rev'))) { d.adr = num(r[6]); d.adrBud = num(r[7]); }
                if (n.includes('Rev Par') || n.includes('å¯å‡ºç§Ÿ')) { d.revpar = num(r[6]); d.revparBud = num(r[7]); }
                
                if (r.length >= 7 && num(r[6]) !== 0) {
                    let type = 'Other';
                    if (/Rate|Negotiated|Tour|Discount|Marketing|Permanent|Surcharge|æœåŠ¡è´¹|Convention|SMRF|Meeting|Consortia|æˆ¿è´¹/.test(n)) type = 'Room';
                    else if (/Kok|Alley|Brasserie|Bar|Ville|Service|Mini|è”šæ™¯|ç™¾å‘³|å»Šå§|ç¾¿åº­|Ling|Wai|Peacock|Long|Salon|é¤/.test(n)) type = 'F&B';
                    else if (/Banquet|å®´ä¼š|Rental|ä¼šè®®/.test(n)) type = 'Banquet';
                    d.rows.push({ name: n, type, actual: num(r[6]), budget: num(r[7]) });
                }
            });
            return d;
        }

        // Dashboard
        function renderDashboard(d) {
            let room = d.totals.room || { act: 0, bud: 0 };
            let fb = d.totals.fb || { act: 0, bud: 0 };
            let other = d.totals.other || { act: 0, bud: 0 };
            let grand = d.totals.hotel || { act: 0, bud: 0 };
            
            if (d.totals.hotel && d.totals.room && d.totals.fb) { 
                other.act = grand.act - room.act - fb.act; 
                other.bud = grand.bud - room.bud - fb.bud; 
            }
            
            // ä¿å­˜è®¡ç®—å¥½çš„ totals
            if (STATE.currentData?.date === d.date) {
                STATE.currentData.totals = { room, fb, other, hotel: grand };
            }

            document.getElementById('current-date').innerText = d.date + ' ' + (d.weekday || '');
            document.getElementById('data-status').innerText = 'å·²åŠ è½½'; 
            document.getElementById('data-status').className = 'tag tag-green';

            const fmt = n => 'Â¥' + Math.floor(n).toLocaleString();
            
            document.getElementById('kpi-revenue').innerText = fmt(grand.act); 
            document.getElementById('kpi-revenue-bud').innerText = fmt(grand.bud);
            const v = grand.bud > 0 ? (grand.act / grand.bud - 1) : 0; 
            const vt = document.getElementById('kpi-revenue-tag'); 
            vt.innerText = (v >= 0 ? '+' : '') + (v * 100).toFixed(1) + '%'; 
            vt.className = `tag ${v >= 0 ? 'tag-green' : 'tag-red'}`;

            const occPct = (d.occupancy || 0) * 100;
            document.getElementById('kpi-occ').innerText = occPct.toFixed(1) + '%'; 
            document.getElementById('kpi-sold').innerText = d.roomsSold;

            document.getElementById('kpi-adr').innerText = fmt(d.adr);
            document.getElementById('kpi-adr-bud').innerText = d.adrBud ? fmt(d.adrBud) : '--';

            document.getElementById('kpi-revpar').innerText = fmt(d.revpar);
            document.getElementById('kpi-revpar-bud').innerText = d.revparBud ? fmt(d.revparBud) : '--';

            renderDeptTable(room, fb, other, grand);
            renderMainChart(room, fb, other);
            
            if (d.aiAnalysis) { 
                document.getElementById('ai-analysis').innerHTML = d.aiAnalysis; 
                document.getElementById('ai-update-time').innerText = new Date().toLocaleString('zh-CN'); 
            }
        }

        function renderDeptTable(room, fb, other, grand) {
            const row = (n, a, b) => { 
                const diff = a - b, p = b > 0 ? (a / b * 100) : 100; 
                return `<tr><td class="text-zinc-300">${n}</td><td class="font-mono">Â¥${(a/10000).toFixed(1)}ä¸‡</td><td class="text-zinc-500 font-mono">Â¥${(b/10000).toFixed(1)}ä¸‡</td><td class="${diff >= 0 ? 'text-green-400' : 'text-red-400'} font-mono">${diff >= 0 ? '+' : ''}${(diff/10000).toFixed(1)}ä¸‡</td><td class="${p >= 100 ? 'text-green-400' : p >= 80 ? 'text-amber-400' : 'text-red-400'}">${p.toFixed(0)}%</td></tr>`; 
            };
            document.getElementById('dept-table-body').innerHTML = row('å®¢æˆ¿ Room', room.act, room.bud) + row('é¤é¥® F&B', fb.act, fb.bud) + row('å…¶ä»– Other', other.act, other.bud) + `<tr class="bg-zinc-800/50 font-medium">${row('åˆè®¡ Total', grand.act, grand.bud).replace(/<\/?tr>/g, '')}</tr>`;
        }

        function renderMainChart(room, fb, other) {
            const el = document.getElementById('main-chart'); 
            if (STATE.charts.main) STATE.charts.main.dispose();
            const chart = echarts.init(el, 'dark'), fmtK = v => (v / 10000).toFixed(0) + 'ä¸‡';
            chart.setOption({ backgroundColor: 'transparent', grid: { left: 5, right: 5, top: 15, bottom: 15, containLabel: true }, xAxis: { type: 'category', data: ['å®¢æˆ¿', 'é¤é¥®', 'å…¶ä»–'], axisLabel: { fontSize: 9 } }, yAxis: { type: 'value', axisLabel: { fontSize: 8, formatter: fmtK }, splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } } }, series: [{ name: 'å®é™…', type: 'bar', data: [room.act, fb.act, other.act], itemStyle: { color: '#3b82f6', borderRadius: [2, 2, 0, 0] }, barWidth: 18, label: { show: true, position: 'top', fontSize: 8, color: '#3b82f6', formatter: p => fmtK(p.value) } }, { name: 'é¢„ç®—', type: 'bar', data: [room.bud, fb.bud, other.bud], itemStyle: { color: '#3f3f46', borderRadius: [2, 2, 0, 0] }, barWidth: 18 }] });
            STATE.charts.main = chart;
        }

        function renderTrendChart(td) {
            const el = document.getElementById('trend-chart'); 
            if (STATE.charts.trend) STATE.charts.trend.dispose();
            if (!td.length) { el.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-600 text-[10px]">æš‚æ— å†å²æ•°æ®</div>'; return; }
            
            const chartData = td.map(d => {
                let adr = d.adr || 0, revpar = d.revpar || 0, occ = (d.occupancy || 0) * 100;
                if (!adr && d.totals?.room && d.roomsSold) adr = d.totals.room.act / d.roomsSold;
                if (!revpar && d.totals?.room) revpar = d.totals.room.act / 260;
                if (!occ && d.roomsSold) occ = (d.roomsSold / 260) * 100;
                return { date: d.date, adr: Math.floor(adr), revpar: Math.floor(revpar), occ: occ.toFixed(1) };
            });
            
            const chart = echarts.init(el, 'dark');
            chart.setOption({ backgroundColor: 'transparent', tooltip: { trigger: 'axis', textStyle: { fontSize: 10 } }, legend: { data: ['ADR', 'RevPAR', 'å…¥ä½ç‡'], bottom: 0, textStyle: { color: '#71717a', fontSize: 8 }, itemWidth: 10, itemHeight: 6 }, grid: { left: 35, right: 30, top: 10, bottom: 28 }, xAxis: { type: 'category', data: chartData.map(d => d.date.slice(5)), axisLabel: { fontSize: 8 }, boundaryGap: false }, yAxis: [{ type: 'value', axisLabel: { fontSize: 8, formatter: v => 'Â¥' + v }, splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } }, min: v => Math.floor(v.min * 0.9) }, { type: 'value', min: 0, max: 100, axisLabel: { formatter: '{value}%', fontSize: 8 } }], series: [{ name: 'ADR', type: 'line', data: chartData.map(d => d.adr), smooth: true, lineStyle: { color: '#f59e0b', width: 2 }, itemStyle: { color: '#f59e0b' }, symbol: 'circle', symbolSize: 5 }, { name: 'RevPAR', type: 'line', data: chartData.map(d => d.revpar), smooth: true, lineStyle: { color: '#a855f7', width: 2 }, itemStyle: { color: '#a855f7' }, symbol: 'circle', symbolSize: 5 }, { name: 'å…¥ä½ç‡', type: 'bar', yAxisIndex: 1, data: chartData.map(d => d.occ), itemStyle: { color: 'rgba(34, 197, 94, 0.4)', borderRadius: [2, 2, 0, 0] }, barWidth: 10 }] });
            STATE.charts.trend = chart;
        }

        // AI åˆ†æ - ç›´æ¥ä¼ é€’å·²è®¡ç®—å¥½çš„æ•°æ®
        async function generateAIAnalysis() {
            if (!STATE.currentData) return;
            const container = document.getElementById('ai-analysis');
            container.innerHTML = '<div class="ai-loading flex items-center justify-center py-8"><div class="spinner mr-2"></div><span class="text-zinc-500 text-[10px]">æ­£åœ¨ç”Ÿæˆåˆ†æ...</span></div>';

            try {
                const d = STATE.currentData;
                const room = d.totals?.room || { act: 0, bud: 0 };
                const fb = d.totals?.fb || { act: 0, bud: 0 };
                const other = d.totals?.other || { act: 0, bud: 0 };
                const hotel = d.totals?.hotel || { act: 0, bud: 0 };
                
                // è®¡ç®—æ‰€æœ‰å·®é¢ï¼ˆå·²è®¡ç®—å¥½ï¼Œç›´æ¥ä¼ ç»™AIï¼‰
                const hotelDiff = hotel.act - hotel.bud;
                const roomDiff = room.act - room.bud;
                const fbDiff = fb.act - fb.bud;
                const otherDiff = other.act - other.bud;
                
                const [year, month, day] = d.date.split('-');
                const dayNum = parseInt(day);
                const daysInMonth = new Date(year, month, 0).getDate();
                const timeProgress = ((dayNum / daysInMonth) * 100).toFixed(0);
                
                // æ„å»ºæ˜ç»† - æŒ‰ç±»å‹åˆ†ç»„
                const roomDetails = d.rows.filter(r => r.type === 'Room').map(r => {
                    const pct = r.budget > 0 ? ((r.actual/r.budget)*100).toFixed(0) : '--';
                    return `${r.name.split(' ')[0]}: Â¥${r.actual.toLocaleString()}, å®Œæˆ${pct}%`;
                }).join('\n');
                
                const fbDetails = d.rows.filter(r => r.type === 'F&B' || r.type === 'Banquet').map(r => {
                    const pct = r.budget > 0 ? ((r.actual/r.budget)*100).toFixed(0) : '--';
                    return `${r.name.split(' ')[0]}: Â¥${r.actual.toLocaleString()}, å®Œæˆ${pct}%`;
                }).join('\n');
                
                const fmtDiff = v => (v >= 0 ? '+' : '') + (v / 10000).toFixed(1) + 'ä¸‡';
                const occPct = ((d.occupancy || 0) * 100).toFixed(1);
                const occBudPct = ((d.occBud || 0) * 100).toFixed(1);
                
                const prompt = STATE.aiPrompt
                    .replace(/{date}/g, d.date)
                    .replace(/{day}/g, dayNum)
                    .replace(/{time_progress}/g, timeProgress)
                    .replace(/{profit_status}/g, hotelDiff >= 0 ? 'ç›ˆä½™' : 'äºæŸ')
                    .replace(/{profit_amount}/g, Math.abs(hotelDiff / 10000).toFixed(1))
                    .replace(/{room_diff}/g, fmtDiff(roomDiff))
                    .replace(/{room_status}/g, roomDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{fb_diff}/g, fmtDiff(fbDiff))
                    .replace(/{fb_status}/g, fbDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{other_diff}/g, fmtDiff(otherDiff))
                    .replace(/{other_status}/g, otherDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{occupancy}/g, occPct)
                    .replace(/{occ_bud}/g, occBudPct)
                    .replace(/{occ_status}/g, parseFloat(occPct) >= parseFloat(occBudPct) ? 'è¾¾æ ‡' : 'æœªè¾¾æ ‡')
                    .replace(/{adr}/g, Math.floor(d.adr || 0))
                    .replace(/{revpar}/g, Math.floor(d.revpar || 0))
                    .replace(/{roomsSold}/g, d.roomsSold)
                    .replace(/{rooms_bud}/g, Math.floor(d.roomsBud || 0))
                    .replace(/{details}/g, `ã€å®¢æˆ¿æ”¶å…¥æ˜ç»†ã€‘\n${roomDetails}\n\nã€é¤é¥®æ”¶å…¥æ˜ç»†ã€‘\n${fbDetails}`);

                const res = await fetch(STATE.qianwen.endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${STATE.qianwen.apiKey}` },
                    body: JSON.stringify({ model: STATE.qianwen.model, messages: [{ role: 'user', content: prompt }], temperature: 0.5, max_tokens: 1200 })
                });
                if (!res.ok) throw new Error();
                const result = await res.json();
                let aiContent = result.choices[0].message.content;
                aiContent = aiContent.replace(/```html\n?/gi, '').replace(/```\n?/g, '').replace(/#{1,3}\s/g, '').replace(/\*\*/g, '').trim();
                container.innerHTML = aiContent;
                document.getElementById('ai-update-time').innerText = new Date().toLocaleString('zh-CN');
                STATE.currentData.aiAnalysis = aiContent;
            } catch (e) {
                console.error(e);
                renderBasicAnalysis();
            }
        }

        function renderBasicAnalysis() {
            if (!STATE.currentData) return;
            const d = STATE.currentData, c = document.getElementById('ai-analysis');
            const hotel = d.totals?.hotel || { act: 0, bud: 0 };
            const room = d.totals?.room || { act: 0, bud: 0 };
            const fb = d.totals?.fb || { act: 0, bud: 0 };
            const other = d.totals?.other || { act: 0, bud: 0 };
            
            const hotelDiff = hotel.act - hotel.bud;
            const roomDiff = room.act - room.bud;
            const fbDiff = fb.act - fb.bud;
            const otherDiff = other.act - other.bud;
            const fmtD = v => (v >= 0 ? '+' : '') + (v / 10000).toFixed(1) + 'ä¸‡';
            
            const goodItems = d.rows.filter(r => r.budget > 1000 && r.actual / r.budget >= 1).slice(0, 5);
            const badItems = d.rows.filter(r => r.budget > 1000 && r.actual / r.budget < 0.8).slice(0, 5);
            
            c.innerHTML = `
                <div class="section-title">ğŸ’° ä»Šæ—¥ç›ˆäº</div>
                <p><strong>ä»Šæ—¥${hotelDiff >= 0 ? 'ç›ˆä½™' : 'äºæŸ'}${Math.abs(hotelDiff / 10000).toFixed(1)}ä¸‡å…ƒ</strong></p>
                <div class="data-row"><span>å®¢æˆ¿æ”¶å…¥</span><span class="${roomDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">${fmtD(roomDiff)}</span></div>
                <p class="sub-item">â†’ å…¥ä½ç‡${((d.occupancy||0)*100).toFixed(1)}%ï¼ˆé¢„ç®—${((d.occBud||0)*100).toFixed(1)}%ï¼‰ï¼Œå”®æˆ¿${d.roomsSold}é—´</p>
                <div class="data-row"><span>é¤é¥®æ”¶å…¥</span><span class="${fbDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">${fmtD(fbDiff)}</span></div>
                <p class="sub-item">â†’ å®Œæˆé¢„ç®—çš„${(fb.bud > 0 ? (fb.act/fb.bud*100).toFixed(0) : 100)}%</p>
                <div class="data-row"><span>å…¶ä»–æ”¶å…¥</span><span class="${otherDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">${fmtD(otherDiff)}</span></div>
                
                <div class="section-title">ğŸ¨ å®¢æˆ¿åˆ†æ</div>
                <p><strong>æˆ¿ä»·æ°´å¹³ï¼š</strong>ADR Â¥${Math.floor(d.adr)}ï¼ŒRevPAR Â¥${Math.floor(d.revpar)}</p>
                
                ${goodItems.length > 0 ? `<div class="section-title">âœ… è¡¨ç°ä¼˜ç§€</div><p class="highlight-good">${goodItems.map(r => r.name.split(' ')[0] + '(' + (r.actual/r.budget*100).toFixed(0) + '%)').join('ã€')}</p>` : ''}
                ${badItems.length > 0 ? `<div class="section-title">âš ï¸ éœ€è¦å…³æ³¨</div><p class="highlight-bad">${badItems.map(r => r.name.split(' ')[0] + '(' + (r.actual/r.budget*100).toFixed(0) + '%)').join('ã€')}</p>` : ''}
            `;
            document.getElementById('ai-update-time').innerText = new Date().toLocaleString('zh-CN');
        }

        // æ·±åº¦åˆ†æ
        function switchDeepTab(tab) {
            ['room', 'fb', 'other'].forEach(t => { const b = document.getElementById(`deep-tab-${t}`); b.classList.toggle('bg-zinc-700', t === tab); b.classList.toggle('text-white', t === tab); b.classList.toggle('text-zinc-400', t !== tab); });
            if (!STATE.currentData) return;
            
            const typeMap = { room: ['Room'], fb: ['F&B', 'Banquet'], other: ['Other'] };
            const nameMap = { room: 'å®¢æˆ¿æ”¶å…¥', fb: 'é¤é¥®æ”¶å…¥', other: 'å…¶ä»–æ”¶å…¥' };
            const rows = STATE.currentData.rows.filter(r => typeMap[tab].includes(r.type)).sort((a, b) => b.actual - a.actual);
            
            document.getElementById('deep-table-head').innerHTML = `<tr><th>é¡¹ç›®åç§°</th><th>å®é™…æ”¶å…¥</th><th>é¢„ç®—é‡‘é¢</th><th>å·®é¢</th><th>å®Œæˆç‡</th></tr>`;
            document.getElementById('deep-table-body').innerHTML = rows.map(r => { 
                const diff = r.actual - r.budget, p = r.budget > 0 ? (r.actual / r.budget * 100) : 100; 
                return `<tr><td class="text-zinc-300">${r.name}</td><td class="font-mono text-white">Â¥${r.actual.toLocaleString()}</td><td class="text-zinc-500 font-mono">Â¥${r.budget.toLocaleString()}</td><td class="${diff >= 0 ? 'text-green-400' : 'text-red-400'} font-mono">${diff >= 0 ? '+' : ''}${Math.floor(diff).toLocaleString()}</td><td class="${p >= 100 ? 'text-green-400' : p >= 80 ? 'text-amber-400' : 'text-red-400'} font-medium">${p.toFixed(0)}%</td></tr>`; 
            }).join('');
            
            const el = document.getElementById('deep-chart'); if (STATE.charts.deep) STATE.charts.deep.dispose();
            const chart = echarts.init(el, 'dark'), top = rows.slice(0, 10);
            chart.setOption({ backgroundColor: 'transparent', tooltip: { trigger: 'axis' }, legend: { data: ['å®é™…æ”¶å…¥', 'é¢„ç®—é‡‘é¢'], bottom: 0, textStyle: { color: '#71717a', fontSize: 9 } }, grid: { left: 10, right: 10, top: 10, bottom: 50, containLabel: true }, xAxis: { type: 'category', data: top.map(r => r.name.split(' ')[0].slice(0, 8)), axisLabel: { rotate: 30, fontSize: 8, color: '#a1a1aa' } }, yAxis: { type: 'value', axisLabel: { fontSize: 8 }, splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } } }, series: [{ name: 'å®é™…æ”¶å…¥', type: 'bar', data: top.map(r => r.actual), itemStyle: { color: '#3b82f6', borderRadius: [2, 2, 0, 0] }, barWidth: 12 }, { name: 'é¢„ç®—é‡‘é¢', type: 'bar', data: top.map(r => r.budget), itemStyle: { color: '#3f3f46', borderRadius: [2, 2, 0, 0] }, barWidth: 12 }] });
            STATE.charts.deep = chart;
            
            const good = rows.filter(r => r.budget > 1000 && r.actual / r.budget >= 1);
            const bad = rows.filter(r => r.budget > 1000 && r.actual / r.budget < 0.8);
            const totalAct = rows.reduce((s, r) => s + r.actual, 0);
            const totalBud = rows.reduce((s, r) => s + r.budget, 0);
            const totalPct = totalBud > 0 ? (totalAct / totalBud * 100).toFixed(0) : 100;
            const totalDiff = totalAct - totalBud;
            
            document.getElementById('deep-summary-content').innerHTML = `
                <p><strong>${nameMap[tab]}æ•´ä½“æƒ…å†µï¼š</strong>å®Œæˆç‡ <span class="${totalPct >= 100 ? 'good' : 'bad'}">${totalPct}%</span>ï¼Œå®é™…Â¥${(totalAct/10000).toFixed(1)}ä¸‡ï¼Œé¢„ç®—Â¥${(totalBud/10000).toFixed(1)}ä¸‡ï¼Œ${totalDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£'}<span class="${totalDiff >= 0 ? 'good' : 'bad'}">${Math.abs(totalDiff/10000).toFixed(1)}ä¸‡</span></p>
                ${good.length > 0 ? `<p class="mt-2"><span class="good">âœ“ è¡¨ç°ä¼˜ç§€ï¼ˆ${good.length}ä¸ªï¼‰ï¼š</span>${good.slice(0,5).map(r => r.name.split(' ')[0] + 'ï¼ˆ' + (r.actual/r.budget*100).toFixed(0) + '%ï¼‰').join('ã€')}</p>` : '<p class="mt-2 text-zinc-500">æš‚æ— è¾¾æ ‡é¡¹ç›®</p>'}
                ${bad.length > 0 ? `<p class="mt-2"><span class="bad">âœ— éœ€è¦å…³æ³¨ï¼ˆ${bad.length}ä¸ªï¼‰ï¼š</span>${bad.slice(0,5).map(r => r.name.split(' ')[0] + 'ï¼ˆ' + (r.actual/r.budget*100).toFixed(0) + '%ï¼‰').join('ã€')}</p>` : ''}
            `;
        }

        window.addEventListener('resize', () => Object.values(STATE.charts).forEach(c => c?.resize()));
        document.addEventListener('DOMContentLoaded', () => { if (STATE.sidebarCollapsed) document.getElementById('sidebar').classList.add('collapsed'); refreshFromGitHub(); });
    </script>
</body>
</html>
