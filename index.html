<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—ç»è¥æ—¥æŠ¥ | NEXUS (ä»£ç†ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg-primary: #0a0a0c; --bg-card: #16161a; --border-color: #232329; --text-primary: #f4f4f5; --text-secondary: #a1a1aa; --text-muted: #71717a; }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: system-ui, sans-serif; font-size: 13px; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; }
        .kpi-card { padding: 12px; position: relative; }
        .kpi-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .kpi-card.blue::before { background: #3b82f6; }
        .kpi-card.green::before { background: #22c55e; }
        .kpi-card.amber::before { background: #f59e0b; }
        .kpi-card.purple::before { background: #a855f7; }
        .kpi-value { font-size: 1.2rem; font-weight: 600; font-family: monospace; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        .tag-green { background: rgba(34,197,94,0.15); color: #4ade80; }
        .tag-red { background: rgba(239,68,68,0.15); color: #f87171; }
        .tag-blue { background: rgba(59,130,246,0.15); color: #60a5fa; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-muted); font-size: 9px; text-transform: uppercase; }
        .sidebar { width: 200px; }
        .sidebar.collapsed { width: 50px; }
        .sidebar.collapsed .sidebar-content { display: none; }
        .history-item { padding: 8px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .history-item:hover { background: rgba(255,255,255,0.05); }
        .history-item.active { background: rgba(59,130,246,0.15); border-left: 2px solid #3b82f6; }
        .month-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .month-content.expanded { max-height: 500px; }
        #toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; }
        .toast { padding: 10px 16px; border-radius: 8px; font-size: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s; }
        .toast-success { background: #166534; }
        .toast-error { background: #991b1b; }
        .toast-info { background: #1e40af; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        .btn-primary { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; font-size: 11px; border: none; cursor: pointer; }
        .btn-primary:disabled { opacity: 0.5; }
        .btn-secondary { background: var(--bg-card); color: var(--text-secondary); padding: 8px 16px; border-radius: 6px; font-size: 11px; border: 1px solid var(--border-color); cursor: pointer; }
        .btn-secondary:hover { background: var(--border-color); }
        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        #ai-analysis { font-size: 11px; line-height: 1.6; }
        #ai-analysis .section-title { color: #3b82f6; font-weight: 600; margin: 12px 0 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border-color); }
        #ai-analysis .highlight-good { color: #4ade80; }
        #ai-analysis .highlight-bad { color: #f87171; }
        #ai-analysis .risk-item { background: rgba(239,68,68,0.1); border-left: 3px solid #ef4444; padding: 8px; margin: 6px 0; border-radius: 0 6px 6px 0; }
        .ai-loading .spinner { width: 16px; height: 16px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .deep-summary { background: #111; border-radius: 8px; padding: 16px; margin-top: 16px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        /* æ–°å¢ï¼šæœˆç´¯è®¡æ•°æ®æ ·å¼ */
        .mtd-header { background: rgba(59,130,246,0.1); }
        .mtd-cell { background: rgba(59,130,246,0.05); }
        /* AIåˆ†æåŒæ¿å—æ ·å¼ */
        .ai-tab { padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .ai-tab.active { background: #3b82f6; color: white; }
        .ai-tab:not(.active) { background: transparent; color: var(--text-muted); }
        .ai-tab:not(.active):hover { background: rgba(255,255,255,0.05); }
        .ai-panel { display: none; }
        .ai-panel.active { display: block; }
    </style>
</head>
<body class="min-h-screen">
<div id="toast-container"></div>
<div class="flex min-h-screen">
    <aside id="sidebar" class="sidebar border-r border-zinc-800 p-3 flex flex-col bg-[#0c0c0e]">
        <button onclick="toggleSidebar()" class="w-full py-2 mb-3 text-zinc-500 hover:text-white text-xs rounded hover:bg-zinc-800"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="sidebar-content flex flex-col flex-1">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center"><i class="fa-solid fa-chart-line text-white text-sm"></i></div>
                <div><span class="font-semibold text-white text-sm">NEXUS</span><span class="text-[9px] text-zinc-500 block">v2.6 æœˆç´¯è®¡ç‰ˆ</span></div>
            </div>
            <label class="block mb-4">
                <div class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 rounded cursor-pointer text-center text-xs font-medium"><i class="fa-solid fa-upload mr-1"></i>ä¸Šä¼ æŠ¥è¡¨</div>
                <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" class="hidden">
            </label>
            <div class="flex items-center justify-between mb-2"><span class="text-[10px] text-zinc-500 uppercase">å†å²è®°å½•</span><span id="history-count" class="text-[10px] text-zinc-600 bg-zinc-800 px-2 rounded">0</span></div>
            <div id="history-list" class="flex-1 overflow-y-auto"></div>
        </div>
    </aside>
    <main class="flex-1 p-4 overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <span id="current-date" class="text-lg font-semibold">--</span>
                <span id="data-status" class="tag tag-red">æ— æ•°æ®</span>
                <span class="tag tag-blue">ğŸŒ ä»£ç†æ¨¡å¼</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="refreshData()" class="btn-secondary px-3" title="åˆ·æ–°"><i class="fa-solid fa-sync"></i></button>
                <button id="save-btn" onclick="saveToGitHub()" disabled class="btn-primary"><i class="fa-solid fa-cloud-arrow-up mr-1"></i>ä¿å­˜</button>
                <button onclick="openSettingsModal()" class="btn-secondary px-3"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="card kpi-card blue"><p class="text-[10px] text-zinc-500 mb-1">æ€»è¥æ”¶</p><p id="kpi-revenue" class="kpi-value">--</p><div class="mt-2 pt-2 border-t border-zinc-800 text-[10px]"><div class="flex justify-between"><span class="text-zinc-500">é¢„ç®—</span><span id="kpi-revenue-bud" class="text-zinc-400">--</span></div><div class="flex justify-between mt-1"><span class="text-zinc-500">å®Œæˆç‡</span><span id="kpi-revenue-pct" class="font-semibold">--</span></div></div></div>
            <div class="card kpi-card green"><p class="text-[10px] text-zinc-500 mb-1">å‡ºç§Ÿç‡</p><p id="kpi-occ" class="kpi-value">--</p><div class="mt-2 pt-2 border-t border-zinc-800 text-[10px]"><div class="flex justify-between"><span class="text-zinc-500">é¢„ç®—</span><span id="kpi-occ-bud" class="text-zinc-400">--</span></div><div class="flex justify-between mt-1"><span class="text-zinc-500">å®é™…å”®å‡ºVSé¢„ç®—</span><span id="kpi-sold">--</span></div></div></div>
            <div class="card kpi-card amber"><p class="text-[10px] text-zinc-500 mb-1">ADR</p><p id="kpi-adr" class="kpi-value">--</p><div class="mt-2 pt-2 border-t border-zinc-800 text-[10px]"><div class="flex justify-between"><span class="text-zinc-500">é¢„ç®—</span><span id="kpi-adr-bud" class="text-zinc-400">--</span></div><div class="flex justify-between mt-1"><span class="text-zinc-500">å®Œæˆç‡</span><span id="kpi-adr-pct" class="font-semibold">--</span></div></div></div>
            <div class="card kpi-card purple"><p class="text-[10px] text-zinc-500 mb-1">RevPAR</p><p id="kpi-revpar" class="kpi-value">--</p><div class="mt-2 pt-2 border-t border-zinc-800 text-[10px]"><div class="flex justify-between"><span class="text-zinc-500">é¢„ç®—</span><span id="kpi-revpar-bud" class="text-zinc-400">--</span></div><div class="flex justify-between mt-1"><span class="text-zinc-500">å®Œæˆç‡</span><span id="kpi-revpar-pct" class="font-semibold">--</span></div></div></div>
        </div>
        <div class="grid grid-cols-12 gap-4">
            <div class="col-span-7 flex flex-col gap-4">
                <div class="card p-4">
                    <div class="flex justify-between mb-3">
                        <span class="text-sm font-medium"><i class="fa-solid fa-layer-group text-blue-400 mr-2"></i>éƒ¨é—¨æ¦‚è§ˆ</span>
                        <button onclick="openDeepDive()" class="text-[10px] text-blue-400 hover:text-blue-300"><i class="fa-solid fa-table-list mr-1"></i>è¯¦ç»†</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2" class="align-bottom">éƒ¨é—¨</th>
                                    <th colspan="4" class="text-center border-b border-zinc-700">ä»Šæ—¥</th>
                                    <th colspan="3" class="text-center mtd-header">æœˆç´¯è®¡ (MTD)</th>
                                </tr>
                                <tr>
                                    <th>å®é™…</th>
                                    <th>é¢„ç®—</th>
                                    <th>å·®é¢</th>
                                    <th>å®Œæˆç‡</th>
                                    <th class="mtd-header">å®é™…</th>
                                    <th class="mtd-header">é¢„ç®—</th>
                                    <th class="mtd-header">å®Œæˆç‡</th>
                                </tr>
                            </thead>
                            <tbody id="dept-table-body">
                                <tr><td colspan="8" class="text-center text-zinc-600 py-4">--</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-4"><span class="text-sm font-medium"><i class="fa-solid fa-chart-bar text-blue-400 mr-2"></i>è¥æ”¶å¯¹æ¯”</span><div id="main-chart" style="height:150px;"></div></div>
                    <div class="card p-4"><span class="text-sm font-medium"><i class="fa-solid fa-chart-pie text-amber-400 mr-2"></i>æ”¶å…¥æ„æˆ</span><div id="pie-chart" style="height:150px;"></div></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-4"><span class="text-sm font-medium"><i class="fa-solid fa-chart-line text-green-400 mr-2"></i>è¥æ”¶è¶‹åŠ¿</span><div id="trend-chart" style="height:200px;"></div></div>
                    <div class="card p-4"><span class="text-sm font-medium"><i class="fa-solid fa-hotel text-purple-400 mr-2"></i>è¿è¥è¶‹åŠ¿</span><div id="ops-trend-chart" style="height:200px;"></div></div>
                </div>
            </div>
            <div class="col-span-5">
                <div class="card p-4 h-full flex flex-col">
                    <div class="flex justify-between mb-3 pb-3 border-b border-zinc-800">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center"><i class="fa-solid fa-robot text-white text-xs"></i></div>
                            <div><span class="text-sm font-medium">AI ç»è¥åˆ†æ</span><div class="text-[9px] text-zinc-500" id="ai-update-time">--</div></div>
                        </div>
                        <button onclick="generateAIAnalysis()" class="btn-secondary px-3 text-[10px]"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>ç”Ÿæˆåˆ†æ</button>
                    </div>
                    <!-- AIåˆ†æåŒæ¿å—åˆ‡æ¢ -->
                    <div class="flex gap-2 mb-3">
                        <button id="ai-tab-daily" onclick="switchAITab('daily')" class="ai-tab active">ğŸ“… ä»Šæ—¥åˆ†æ</button>
                        <button id="ai-tab-monthly" onclick="switchAITab('monthly')" class="ai-tab">ğŸ“Š æœˆåº¦åˆ†æ</button>
                    </div>
                    <div id="ai-analysis" class="flex-1 overflow-y-auto" style="max-height:600px;">
                        <div id="ai-panel-daily" class="ai-panel active">
                            <div class="flex flex-col items-center justify-center py-12 text-zinc-600">
                                <i class="fa-solid fa-wand-magic-sparkles text-2xl mb-3"></i>
                                <span class="text-xs">ç‚¹å‡»"ç”Ÿæˆåˆ†æ"æŒ‰é’®ç”Ÿæˆä»Šæ—¥æŠ¥å‘Š</span>
                            </div>
                        </div>
                        <div id="ai-panel-monthly" class="ai-panel">
                            <div class="flex flex-col items-center justify-center py-12 text-zinc-600">
                                <i class="fa-solid fa-calendar-days text-2xl mb-3"></i>
                                <span class="text-xs">ç‚¹å‡»"ç”Ÿæˆåˆ†æ"æŒ‰é’®ç”Ÿæˆæœˆåº¦æŠ¥å‘Š</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div id="settings-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center">
    <div class="bg-zinc-900 rounded-xl p-5 w-full max-w-lg border border-zinc-700">
        <div class="flex justify-between mb-4"><h3 class="font-semibold"><i class="fa-solid fa-gear text-blue-400 mr-2"></i>è®¾ç½®</h3><button onclick="closeModal('settings-modal')" class="text-zinc-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
        <div class="mb-4 p-3 bg-blue-900/30 border border-blue-700/50 rounded text-xs text-blue-300"><i class="fa-solid fa-shield-alt mr-1"></i>ä»£ç†æ¨¡å¼ - ä½¿ç”¨ ghproxy.net åŠ é€Ÿè®¿é—®</div>
        <div class="mb-4"><label class="text-[10px] text-zinc-500">Webhook URL</label><input type="text" id="settings-webhook" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-xs"></div>
        <div class="mb-4">
            <label class="text-[10px] text-zinc-500">ä»Šæ—¥åˆ†ææç¤ºè¯</label>
            <textarea id="settings-ai-prompt-daily" rows="5" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-xs"></textarea>
        </div>
        <div class="mb-4">
            <label class="text-[10px] text-zinc-500">æœˆåº¦åˆ†ææç¤ºè¯</label>
            <textarea id="settings-ai-prompt-monthly" rows="5" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-xs"></textarea>
        </div>
        <div class="flex justify-end gap-2"><button onclick="closeModal('settings-modal')" class="btn-secondary">å–æ¶ˆ</button><button onclick="saveSettings()" class="btn-primary">ä¿å­˜</button></div>
    </div>
</div>
<div id="deep-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex flex-col">
    <div class="h-12 px-4 border-b border-zinc-800 flex items-center justify-between bg-[#0c0c0e]">
        <button onclick="closeModal('deep-modal')" class="text-zinc-400 hover:text-white text-sm"><i class="fa-solid fa-arrow-left mr-2"></i>è¿”å›</button>
        <div class="flex gap-2"><button id="deep-tab-room" onclick="switchDeepTab('room')" class="px-4 py-1 rounded text-xs bg-zinc-700">å®¢æˆ¿</button><button id="deep-tab-fb" onclick="switchDeepTab('fb')" class="px-4 py-1 rounded text-xs text-zinc-400">é¤é¥®</button><button id="deep-tab-other" onclick="switchDeepTab('other')" class="px-4 py-1 rounded text-xs text-zinc-400">å…¶ä»–</button></div>
    </div>
    <div class="flex-1 overflow-y-auto p-4 bg-[#09090b]">
        <div class="max-w-5xl mx-auto grid grid-cols-2 gap-4">
            <div class="card p-4"><h4 class="text-sm font-medium mb-3">æ”¶å…¥æ˜ç»†</h4><div class="overflow-auto max-h-80"><table><thead id="deep-table-head"></thead><tbody id="deep-table-body"></tbody></table></div></div>
            <div class="card p-4"><h4 class="text-sm font-medium mb-3">TOP10</h4><div id="deep-chart" style="height:280px;"></div></div>
        </div>
        <div class="max-w-5xl mx-auto deep-summary mt-4"><div id="deep-summary-content">--</div></div>
    </div>
</div>
<script>
const NAME_MAP = {'corporate':'åè®®å…¬å¸','individual':'æ•£å®¢','tour':'æ—…è¡Œå›¢','discount':'æŠ˜æ‰£','convention':'ä¼šè®®','permanent':'é•¿ä½','kok thai':'æ³°é¤å…','brasserie':'è¥¿é¤å…','bar':'é…’å§','mini bar':'è¿·ä½ å§','room service':'é€é¤','banquet':'å®´ä¼š','rental':'ç§Ÿèµ','laundry':'æ´—è¡£','parking':'åœè½¦','spa':'æ°´ç–—'};
function getChineseName(n){if(!n)return'æœªçŸ¥';if(/[\u4e00-\u9fa5]/.test(n)){const m=n.match(/[\u4e00-\u9fa5]+/);if(m)return m[0];}const l=n.toLowerCase();for(const k in NAME_MAP)if(l.includes(k))return NAME_MAP[k];return n.split(/[\s\-_]/)[0].slice(0,8);}

// ä»Šæ—¥åˆ†ææç¤ºè¯
const DEFAULT_PROMPT_DAILY = `ä½ æ˜¯äº”æ˜Ÿçº§é…’åº—çš„èµ„æ·±ç»è¥åˆ†æå¸ˆã€‚åŸºäºä»Šæ—¥æ•°æ®ç”Ÿæˆä¸“ä¸šçš„HTMLåˆ†ææŠ¥å‘Šã€‚

ã€ä»Šæ—¥æ€»ä½“æ•°æ®ã€‘
æ—¥æœŸ: {date}
æ•´ä½“å®Œæˆç‡: {total_pct}%
å®¢æˆ¿æ”¶å…¥å®Œæˆç‡: {room_pct}%
é¤é¥®æ”¶å…¥å®Œæˆç‡: {fb_pct}%
å…¶ä»–æ”¶å…¥å®Œæˆç‡: {other_pct}%
å‡ºç§Ÿç‡: {occupancy}% (é¢„ç®—: {occ_bud}%)
ADR: Â¥{adr} (é¢„ç®—: Â¥{adr_bud})
RevPAR: Â¥{revpar} (é¢„ç®—: Â¥{revpar_bud})

ã€å®¢æˆ¿ç»†åˆ†æ•°æ®ã€‘
{room_details}

ã€é¤é¥®ç»†åˆ†æ•°æ®ã€‘
{fb_details}

ã€å…¶ä»–ç»†åˆ†æ•°æ®ã€‘
{other_details}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼ç”ŸæˆHTMLæŠ¥å‘Šï¼ˆç›´æ¥è¾“å‡ºHTMLï¼Œä¸è¦ä»»ä½•è§£é‡Šï¼‰ï¼š

<div class="section-title">ğŸ“Š ä»Šæ—¥é¢„ç®—æ‰§è¡Œæ€»è§ˆ</div>
<p><strong>æ•´ä½“å®Œæˆç‡ï¼š<span class="highlight-xxx">XX%</span></strong></p>
<p>å®¢æˆ¿<span class="highlight-xxx">XX%</span> é¤é¥®<span class="highlight-xxx">XX%</span> å…¶ä»–<span class="highlight-xxx">XX%</span></p>

<div class="section-title">ğŸ¨ å®¢æˆ¿åˆ†æ</div>
<p>âœ“ è¡¨ç°ä¼˜ç§€ï¼š</p>
<p>â€¢ é¡¹ç›®åï¼š<span class="highlight-good">XXX%</span>ï¼ˆåˆ†æåŸå› ï¼‰</p>
<p>âœ— éœ€è¦æ”¹è¿›ï¼š</p>
<p>â€¢ é¡¹ç›®åï¼š<span class="highlight-bad">XX%</span>ï¼ˆåˆ†æåŸå› ï¼‰</p>
<p>ğŸ’¡ å»ºè®®ï¼š</p>
<p>1. å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®</p>
<p>2. å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®</p>

<div class="section-title">ğŸ½ï¸ é¤é¥®åˆ†æ</div>
<p>âœ“ è¡¨ç°ä¼˜ç§€ï¼š</p>
<p>â€¢ é¤å…/é¡¹ç›®åï¼š<span class="highlight-good">XXX%</span></p>
<p>âœ— éœ€è¦æ”¹è¿›ï¼š</p>
<p>â€¢ é¤å…/é¡¹ç›®åï¼š<span class="highlight-bad">XX%</span></p>
<p>ğŸ’¡ å»ºè®®ï¼šå…·ä½“é¤å…æ”¹è¿›æªæ–½</p>

<div class="section-title">âš ï¸ é£é™©é¢„è­¦</div>
<div class="risk-item">ğŸ”´ é£é™©ç‚¹ï¼š
â€¢ å…¥ä½ç‡{occupancy}%ä½äºé¢„ç®—{occ_bud}%ï¼Œéœ€å…³æ³¨
â€¢ ä»Šæ—¥æ”¶å…¥ç¼ºå£åŠä¸»è¦æ¥æºåˆ†æ
</div>

<div class="section-title">ğŸ“ˆ ä»Šæ—¥å°ç»“</div>
<p>é‡ç‚¹å…³æ³¨ï¼š1)XX 2)XX 3)XX</p>
<p>æ˜æ—¥è¡ŒåŠ¨ï¼š1)XX 2)XX 3)XX</p>

è§„åˆ™ï¼š
- â‰¥100%ç”¨class="highlight-good"ï¼Œ<80%ç”¨class="highlight-bad"
- åˆ†æè¦å…·ä½“ï¼Œå»ºè®®è¦å¯æ‰§è¡Œ
- ç›´æ¥è¾“å‡ºçº¯HTMLï¼Œç¦æ­¢è¾“å‡ºä»»ä½•è§£é‡Šè¯´æ˜`;

// æœˆåº¦åˆ†ææç¤ºè¯
const DEFAULT_PROMPT_MONTHLY = `ä½ æ˜¯äº”æ˜Ÿçº§é…’åº—çš„èµ„æ·±ç»è¥åˆ†æå¸ˆã€‚åŸºäºæœˆåº¦ç´¯è®¡æ•°æ®ç”Ÿæˆä¸“ä¸šçš„HTMLåˆ†ææŠ¥å‘Šã€‚

ã€æœˆåº¦æ€»ä½“æ•°æ®ã€‘
å½“å‰æ—¥æœŸ: {date}
æœ¬æœˆç¬¬{day_of_month}å¤©ï¼Œæ—¶é—´è¿›åº¦: {time_progress}%
æœˆç´¯è®¡æ•´ä½“å®Œæˆç‡: {mtd_total_pct}%
æœˆç´¯è®¡å®¢æˆ¿å®Œæˆç‡: {mtd_room_pct}%
æœˆç´¯è®¡é¤é¥®å®Œæˆç‡: {mtd_fb_pct}%
æœˆç´¯è®¡å…¶ä»–å®Œæˆç‡: {mtd_other_pct}%
æœˆç´¯è®¡å®é™…è¥æ”¶: Â¥{mtd_total_act}ä¸‡
æœˆç´¯è®¡é¢„ç®—è¥æ”¶: Â¥{mtd_total_bud}ä¸‡
æœˆç´¯è®¡å·®é¢: Â¥{mtd_variance}ä¸‡

ã€å®¢æˆ¿ç»†åˆ†æœˆç´¯è®¡ã€‘
{mtd_room_details}

ã€é¤é¥®ç»†åˆ†æœˆç´¯è®¡ã€‘
{mtd_fb_details}

ã€å…¶ä»–ç»†åˆ†æœˆç´¯è®¡ã€‘
{mtd_other_details}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼ç”ŸæˆHTMLæŠ¥å‘Šï¼ˆç›´æ¥è¾“å‡ºHTMLï¼Œä¸è¦ä»»ä½•è§£é‡Šï¼‰ï¼š

<div class="section-title">ğŸ“Š æœˆåº¦é¢„ç®—æ‰§è¡Œæ€»è§ˆ</div>
<p><strong>æœˆç´¯è®¡å®Œæˆç‡ï¼š<span class="highlight-xxx">{mtd_total_pct}%</span></strong>ï¼ˆæ—¶é—´è¿›åº¦{time_progress}%ï¼‰</p>
<p>å®¢æˆ¿<span class="highlight-xxx">XX%</span> é¤é¥®<span class="highlight-xxx">XX%</span> å…¶ä»–<span class="highlight-xxx">XX%</span></p>
<p>æ”¶å…¥è¿›åº¦ vs æ—¶é—´è¿›åº¦ï¼š<span class="highlight-xxx">è½å/é¢†å…ˆXä¸ªç™¾åˆ†ç‚¹</span></p>

<div class="section-title">ğŸ¨ å®¢æˆ¿æœˆåº¦åˆ†æ</div>
<p>âœ“ è¡¨ç°ä¼˜ç§€ï¼š</p>
<p>â€¢ é¡¹ç›®åï¼š<span class="highlight-good">XXX%</span></p>
<p>âœ— éœ€è¦æ”¹è¿›ï¼š</p>
<p>â€¢ é¡¹ç›®åï¼š<span class="highlight-bad">XX%</span></p>
<p>ğŸ’¡ æœˆåº¦ç­–ç•¥ï¼šå®¢æºç»“æ„ä¼˜åŒ–ã€ä»·æ ¼ç­–ç•¥ç­‰</p>

<div class="section-title">ğŸ½ï¸ é¤é¥®æœˆåº¦åˆ†æ</div>
<p>âœ“ è¡¨ç°ä¼˜ç§€ï¼š</p>
<p>â€¢ é¤å…/é¡¹ç›®åï¼š<span class="highlight-good">XXX%</span></p>
<p>âœ— éœ€è¦æ”¹è¿›ï¼š</p>
<p>â€¢ é¤å…/é¡¹ç›®åï¼š<span class="highlight-bad">XX%</span></p>
<p>ğŸ’¡ æœˆåº¦ç­–ç•¥ï¼šé¤å…æ”¹è¿›æªæ–½</p>

<div class="section-title">âš ï¸ æœˆåº¦é£é™©é¢„è­¦</div>
<div class="risk-item">ğŸ”´ å…³é”®é£é™©ï¼š
â€¢ æ”¶å…¥è¿›åº¦{mtd_total_pct}% vs æ—¶é—´è¿›åº¦{time_progress}%
â€¢ æŒ‰å½“å‰è¶‹åŠ¿é¢„è®¡æœˆåº•å®Œæˆç‡
â€¢ ä¸»è¦æ‹–ç´¯æ¿å—åˆ†æ
</div>

<div class="section-title">ğŸ“ˆ æœˆåº¦è¿›å±•ä¸é¢„æµ‹</div>
<p>æœ¬æœˆç¬¬{day_of_month}å¤©ï¼Œå‰©ä½™XXå¤©</p>
<p>ğŸ¯ è¦å®Œæˆæœˆåº¦ç›®æ ‡ï¼Œå‰©ä½™æ¯æ—¥éœ€è¾¾æˆç›®æ ‡</p>
<p>ğŸ’¡ é‡ç‚¹è¡ŒåŠ¨ï¼š</p>
<p>1. ç«‹å³è¡ŒåŠ¨ï¼šXX</p>
<p>2. æœ¬å‘¨é‡ç‚¹ï¼šXX</p>
<p>3. æœˆåº•å†²åˆºï¼šXX</p>

è§„åˆ™ï¼š
- â‰¥100%ç”¨class="highlight-good"ï¼Œ<80%ç”¨class="highlight-bad"
- åˆ†ææ”¶å…¥è¿›åº¦ä¸æ—¶é—´è¿›åº¦çš„å·®è·
- å»ºè®®è¦å…·ä½“å¯æ‰§è¡Œ
- ç›´æ¥è¾“å‡ºçº¯HTMLï¼Œç¦æ­¢è¾“å‡ºä»»ä½•è§£é‡Šè¯´æ˜`;

const REMOTE_BASE = 'https://ghproxy.net/https://raw.githubusercontent.com/QIAN123-KIWI/hotel-daily-reportV3/main/data';

const STATE = {
    currentData: null, 
    historyIndex: [], 
    historyData: {}, 
    charts: {},
    mtdData: { room: {act:0, bud:0}, fb: {act:0, bud:0}, other: {act:0, bud:0}, hotel: {act:0, bud:0} },
    webhookUrl: localStorage.getItem('nexus_webhook_url') || 'https://n8n-fzlhzvbn.ap-northeast-1.clawcloudrun.com/webhook/hotel-save',
    qianwen: { apiKey: 'sk-d8f9d80c5d154e5fa8ce9413560ccfe8', model: 'qwen-max', endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions' },
    aiPromptDaily: localStorage.getItem('nexus_ai_prompt_daily') || DEFAULT_PROMPT_DAILY,
    aiPromptMonthly: localStorage.getItem('nexus_ai_prompt_monthly') || DEFAULT_PROMPT_MONTHLY
};

function showToast(m, t='info') {
    const c = document.getElementById('toast-container'), e = document.createElement('div');
    e.className = `toast toast-${t}`;
    e.innerHTML = `<i class="fa-solid ${t==='success'?'fa-check-circle':t==='error'?'fa-exclamation-circle':'fa-info-circle'}"></i><span>${m}</span>`;
    c.appendChild(e);
    setTimeout(() => e.remove(), 3000);
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); setTimeout(() => Object.values(STATE.charts).forEach(c => c?.resize()), 300); }

function openSettingsModal() { 
    document.getElementById('settings-webhook').value = STATE.webhookUrl; 
    document.getElementById('settings-ai-prompt-daily').value = STATE.aiPromptDaily; 
    document.getElementById('settings-ai-prompt-monthly').value = STATE.aiPromptMonthly; 
    document.getElementById('settings-modal').classList.remove('hidden'); 
}

function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function saveSettings() { 
    STATE.webhookUrl = document.getElementById('settings-webhook').value.trim(); 
    STATE.aiPromptDaily = document.getElementById('settings-ai-prompt-daily').value.trim() || DEFAULT_PROMPT_DAILY; 
    STATE.aiPromptMonthly = document.getElementById('settings-ai-prompt-monthly').value.trim() || DEFAULT_PROMPT_MONTHLY; 
    localStorage.setItem('nexus_webhook_url', STATE.webhookUrl); 
    localStorage.setItem('nexus_ai_prompt_daily', STATE.aiPromptDaily); 
    localStorage.setItem('nexus_ai_prompt_monthly', STATE.aiPromptMonthly); 
    closeModal('settings-modal'); 
    showToast('è®¾ç½®å·²ä¿å­˜', 'success'); 
}

function switchAITab(tab) {
    document.getElementById('ai-tab-daily').classList.toggle('active', tab === 'daily');
    document.getElementById('ai-tab-monthly').classList.toggle('active', tab === 'monthly');
    document.getElementById('ai-panel-daily').classList.toggle('active', tab === 'daily');
    document.getElementById('ai-panel-monthly').classList.toggle('active', tab === 'monthly');
}

async function refreshData() {
    showToast('æ­£åœ¨åŠ è½½æ•°æ®(ä»£ç†æ¨¡å¼)...', 'info');
    try {
        const res = await fetch(REMOTE_BASE + '/index.json?t=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        STATE.historyIndex = await res.json();
        showToast('å·²åŠ è½½ ' + STATE.historyIndex.length + ' æ¡è®°å½•', 'success');
        renderHistoryList();
        if (STATE.historyIndex.length) {
            const sorted = [...STATE.historyIndex].sort((a,b) => b.date.localeCompare(a.date));
            await loadDayData(sorted[0].date);
        }
        await loadTrendData();
    } catch (e) {
        console.error('åŠ è½½å¤±è´¥:', e);
        showToast('ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    }
}

async function loadDayData(date) {
    if (STATE.historyData[date]) {
        STATE.currentData = STATE.historyData[date];
        await calculateMTD(date);
        renderDashboard(STATE.currentData);
        displayAI(STATE.currentData);
        document.querySelectorAll('.history-item').forEach(el => el.classList.toggle('active', el.dataset.date === date));
        document.getElementById('save-btn').disabled = false;
        return;
    }
    try {
        const [y, m] = date.split('-');
        const res = await fetch(REMOTE_BASE + '/' + y + '/' + m + '/' + date + '.json?t=' + Date.now());
        if (!res.ok) throw new Error();
        const d = await res.json();
        STATE.historyData[date] = d;
        STATE.currentData = d;
        await calculateMTD(date);
        renderDashboard(d);
        displayAI(d);
        document.querySelectorAll('.history-item').forEach(el => el.classList.toggle('active', el.dataset.date === date));
        document.getElementById('save-btn').disabled = false;
    } catch (e) { console.error('åŠ è½½å¤±è´¥:', date, e); }
}

async function calculateMTD(currentDate) {
    const [year, month] = currentDate.split('-');
    const monthPrefix = `${year}-${month}`;
    
    const monthDates = STATE.historyIndex
        .filter(i => i.date.startsWith(monthPrefix) && i.date <= currentDate)
        .map(i => i.date)
        .sort();
    
    STATE.mtdData = { 
        room: {act:0, bud:0}, 
        fb: {act:0, bud:0}, 
        other: {act:0, bud:0}, 
        hotel: {act:0, bud:0} 
    };
    
    for (const date of monthDates) {
        let dayData = STATE.historyData[date];
        if (!dayData) {
            try {
                const [y, m] = date.split('-');
                const res = await fetch(REMOTE_BASE + '/' + y + '/' + m + '/' + date + '.json');
                if (res.ok) {
                    dayData = await res.json();
                    STATE.historyData[date] = dayData;
                }
            } catch {}
        }
        
        if (dayData && dayData.totals) {
            const t = dayData.totals;
            if (t.room) {
                STATE.mtdData.room.act += t.room.act || 0;
                STATE.mtdData.room.bud += t.room.bud || 0;
            }
            if (t.fb) {
                STATE.mtdData.fb.act += t.fb.act || 0;
                STATE.mtdData.fb.bud += t.fb.bud || 0;
            }
            if (t.hotel) {
                STATE.mtdData.hotel.act += t.hotel.act || 0;
                STATE.mtdData.hotel.bud += t.hotel.bud || 0;
            }
            if (t.hotel && t.room && t.fb) {
                STATE.mtdData.other.act += (t.hotel.act || 0) - (t.room.act || 0) - (t.fb.act || 0);
                STATE.mtdData.other.bud += (t.hotel.bud || 0) - (t.room.bud || 0) - (t.fb.bud || 0);
            }
        }
    }
    console.log('æœˆç´¯è®¡æ•°æ®:', STATE.mtdData);
}

function displayAI(data) {
    const dailyPanel = document.getElementById('ai-panel-daily');
    const monthlyPanel = document.getElementById('ai-panel-monthly');
    
    if (data.aiAnalysisDaily) { 
        dailyPanel.innerHTML = data.aiAnalysisDaily; 
    } else { 
        dailyPanel.innerHTML = '<div class="text-center py-12 text-zinc-600"><i class="fa-solid fa-wand-magic-sparkles text-2xl mb-3"></i><p class="text-xs">ç‚¹å‡»"ç”Ÿæˆåˆ†æ"æŒ‰é’®ç”Ÿæˆä»Šæ—¥æŠ¥å‘Š</p></div>'; 
    }
    
    if (data.aiAnalysisMonthly) { 
        monthlyPanel.innerHTML = data.aiAnalysisMonthly; 
    } else { 
        monthlyPanel.innerHTML = '<div class="text-center py-12 text-zinc-600"><i class="fa-solid fa-calendar-days text-2xl mb-3"></i><p class="text-xs">ç‚¹å‡»"ç”Ÿæˆåˆ†æ"æŒ‰é’®ç”Ÿæˆæœˆåº¦æŠ¥å‘Š</p></div>'; 
    }
    
    document.getElementById('ai-update-time').textContent = data.aiAnalysisTime || '--';
}

async function loadTrendData() {
    const sorted = [...STATE.historyIndex].sort((a,b) => a.date.localeCompare(b.date)).slice(-30);
    const data = [];
    for (const i of sorted) {
        if (STATE.historyData[i.date]) data.push(STATE.historyData[i.date]);
        else try {
            const [y,m] = i.date.split('-');
            const res = await fetch(REMOTE_BASE + '/' + y + '/' + m + '/' + i.date + '.json');
            if (res.ok) { const d = await res.json(); STATE.historyData[i.date] = d; data.push(d); }
        } catch {}
    }
    renderTrendChart(data);
    renderOpsTrendChart(data);
}

async function saveToGitHub() {
    if (!STATE.currentData) return showToast('è¯·å…ˆä¸Šä¼ æ•°æ®', 'error');
    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>ä¿å­˜ä¸­';
    try {
        const data = { ...STATE.currentData, savedAt: new Date().toISOString() };
        const hasAI = data.aiAnalysisDaily ? 'ï¼ˆå«AIåˆ†æï¼‰' : '';
        const res = await fetch(STATE.webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        showToast('ä¿å­˜æˆåŠŸ' + hasAI + 'ï¼è¯·ç­‰å¾…1-2åˆ†é’Ÿååˆ·æ–°', 'success');
    } catch (e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-1"></i>ä¿å­˜'; }
}

function renderHistoryList() {
    const c = document.getElementById('history-list');
    document.getElementById('history-count').textContent = STATE.historyIndex.length;
    if (!STATE.historyIndex.length) { c.innerHTML = '<div class="text-center py-8 text-zinc-600 text-xs">æš‚æ— æ•°æ®</div>'; return; }
    const groups = {};
    STATE.historyIndex.forEach(i => { const k = i.date.slice(0,7); if(!groups[k]) groups[k]=[]; groups[k].push(i); });
    let html = '';
    Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).forEach(([m, items], idx) => {
        items.sort((a,b) => b.date.localeCompare(a.date));
        html += '<div class="mb-2"><div onclick="this.nextElementSibling.classList.toggle(\'expanded\');this.querySelector(\'i\').classList.toggle(\'rotate-90\')" class="flex justify-between p-2 rounded cursor-pointer hover:bg-zinc-800 text-xs text-zinc-400"><span><i class="fa-solid fa-chevron-right mr-1 transition-transform ' + (idx===0?'rotate-90':'') + '" style="font-size:8px"></i>' + m + '</span><span class="text-zinc-600">' + items.length + '</span></div><div class="month-content ' + (idx===0?'expanded':'') + '">' + items.map(i => '<div class="history-item flex justify-between" data-date="' + i.date + '" onclick="loadDayData(\'' + i.date + '\')"><span>' + i.date.slice(8) + 'æ—¥</span><span class="' + ((i.variance||0)>=0?'text-green-400':'text-red-400') + ' font-mono text-[10px]">' + ((i.variance||0)>=0?'+':'') + ((i.variance||0)*100).toFixed(1) + '%</span></div>').join('') + '</div></div>';
    });
    c.innerHTML = html;
}

function handleFileUpload(e) {
    const f = e.target.files[0]; if (!f) return;
    const fn = f.name.replace(/\.(xlsx|xls|csv)$/i, '');
    let dateFromFn = null;
    const m1 = fn.match(/(\d{4})[-._](\d{1,2})[-._](\d{1,2})/);
    if (m1) dateFromFn = m1[1] + '-' + m1[2].padStart(2,'0') + '-' + m1[3].padStart(2,'0');
    const reader = new FileReader();
    reader.onload = async ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        const parsed = parseExcelData(rows);
        if (dateFromFn) { parsed.date = dateFromFn; parsed.weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(dateFromFn).getDay()]; }
        STATE.currentData = parsed;
        STATE.historyData[parsed.date] = parsed;
        
        // å¦‚æœExcelä¸­æœ‰æœˆç´¯è®¡æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™è®¡ç®—
        if (parsed.mtd && parsed.mtd.hotel && parsed.mtd.hotel.act > 0) {
            console.log('ä½¿ç”¨Excelä¸­çš„æœˆç´¯è®¡æ•°æ®:', parsed.mtd);
        } else {
            await calculateMTD(parsed.date);
        }
        
        renderDashboard(parsed);
        document.getElementById('save-btn').disabled = false;
        showToast('å·²åŠ è½½ ' + parsed.date, 'success');
        
        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å·²æœ‰ä¿å­˜çš„AIåˆ†æ
        const savedData = STATE.historyData[parsed.date];
        if (savedData && savedData.aiAnalysisDaily) {
            // ä½¿ç”¨å·²ä¿å­˜çš„AIåˆ†æ
            parsed.aiAnalysisDaily = savedData.aiAnalysisDaily;
            parsed.aiAnalysisMonthly = savedData.aiAnalysisMonthly;
            parsed.aiAnalysisTime = savedData.aiAnalysisTime;
            STATE.currentData = parsed;
            displayAI(parsed);
            showToast('å·²åŠ è½½ä¿å­˜çš„AIåˆ†æ', 'success');
        } else {
            // æ²¡æœ‰ä¿å­˜çš„åˆ†æï¼Œæ˜¾ç¤ºå ä½ç¬¦
            displayAI(parsed);
        }
    };
    reader.readAsArrayBuffer(f);
    e.target.value = '';
}

function parseExcelData(rows) {
    let d = { 
        date: new Date().toISOString().split('T')[0], 
        weekday: '', 
        rows: [], 
        roomsSold: 0, roomsBud: 0, 
        occupancy: 0, occBud: 0, 
        adr: 0, adrBud: 0, 
        revpar: 0, revparBud: 0, 
        totals: {},
        mtd: {
            room: { act: 0, bud: 0 },
            fb: { act: 0, bud: 0 },
            hotel: { act: 0, bud: 0 },
            other: { act: 0, bud: 0 }
        }
    };
    const num = v => { if(v==null||v==='')return 0; return parseFloat(String(v).replace(/[Â¥,$%]/g,''))||0; };
    const pct = v => { if(v==null||v==='')return 0; const n=parseFloat(String(v).replace('%',''));return isNaN(n)?0:(n>1?n/100:n); };
    
    let subTotalCount = 0; // è®¡æ•°å°è®¡è¡Œ
    
    rows.forEach((r, rowIdx) => {
        if (!r[0]) return;
        const n = String(r[0]).trim();
        
        // æ—¥æœŸè§£æ
        if (n.includes('Date')||n.includes('æ—¥æœŸ')) { 
            const m=r.join(' ').match(/(\d{1,2})\/(\w+)\/(\d{4})/);
            if(m){
                const mm={Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
                d.date=m[3]+'-'+(mm[m[2]]||m[2])+'-'+m[1].padStart(2,'0');
                d.weekday=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(d.date).getDay()];
            }
        }
        
        // ===== æ€»æˆ¿æ”¶å…¥ =====
        if (n.includes('Total room Revenue')||n.includes('æ€»æˆ¿æ”¶å…¥')) {
            d.totals.room={act:num(r[6]),bud:num(r[7])};
            d.mtd.room={act:num(r[8]),bud:num(r[10])};
            console.log('è§£ææ€»æˆ¿æ”¶å…¥:', d.totals.room, 'MTD:', d.mtd.room);
        }
        
        // ===== å°è®¡å¤„ç† =====
        if (n.includes('Sub') && n.includes('Total') && n.includes('å°è®¡')) {
            subTotalCount++;
            if (subTotalCount === 2) {
                // ç¬¬äºŒä¸ªå°è®¡ = å®´ä¼šå°è®¡ï¼Œæ·»åŠ åˆ°é¤é¥®æ˜ç»†
                d.rows.push({
                    name: 'å®´ä¼šæ”¶å…¥',
                    type: 'F&B',
                    actual: num(r[6]),
                    budget: num(r[7]),
                    mtdActual: num(r[8]),
                    mtdBudget: num(r[10])
                });
                console.log('æ·»åŠ å®´ä¼šæ”¶å…¥åˆ°é¤é¥®æ˜ç»†:', num(r[6]), num(r[8]));
            }
            return;
        }
        
        // ===== é¤é¥®æ€»è®¡ =====
        if (n.includes('F&B Total')||n.includes('é¤é¥®æ”¶å…¥åˆè®¡')) {
            d.totals.fb={act:num(r[6]),bud:num(r[7])};
            d.mtd.fb={act:num(r[8]),bud:num(r[10])};
            console.log('è§£æé¤é¥®æ€»è®¡:', d.totals.fb, 'MTD:', d.mtd.fb);
        }
        
        // ===== é…’åº—æ€»æ”¶å…¥ =====
        if (n.includes('Total Hotel Revenue')||n.includes('é…’åº—æ”¶å…¥åˆè®¡')) {
            d.totals.hotel={act:num(r[6]),bud:num(r[7])};
            d.mtd.hotel={act:num(r[8]),bud:num(r[10])};
            console.log('è§£æé…’åº—æ€»æ”¶å…¥:', d.totals.hotel, 'MTD:', d.mtd.hotel);
        }
        
        // ===== å…¶ä»–ç»è¥æ”¶å…¥åˆè®¡ =====
        if (n.includes('Total Other Operating')||n.includes('å…¶ä»–ç»è¥æ”¶å…¥åˆè®¡')) {
            d.totals.other={act:num(r[6]),bud:num(r[7])};
            d.mtd.other={act:num(r[8]),bud:num(r[10])};
        }
        
        // è¿è¥æŒ‡æ ‡
        if (n.includes('Occupied Rooms')||n.includes('å·²å‡ºç§Ÿæˆ¿æ•°')) { 
            d.roomsSold=Math.round(num(r[6]));
            d.roomsBud=Math.round(num(r[7])); 
        }
        if ((n.includes('Paid Occupancy')||n.includes('å®¢æˆ¿ä½æˆ¿ç‡')) && !n.includes('Rate')) { 
            d.occupancy=pct(r[6]);
            d.occBud=pct(r[7]); 
        }
        if (n.includes('Paid Average Room Rate')||(n.includes('å¹³å‡æˆ¿ä»·')&&!n.includes('Rev')&&!n.includes('å¯å‡ºç§Ÿ'))) { 
            d.adr=num(r[6]);
            d.adrBud=num(r[7]); 
        }
        if (n.includes('Rev Par')||n.includes('RevPAR')||n.includes('å¯å‡ºç§Ÿå¹³å‡æˆ¿ä»·')) { 
            d.revpar=num(r[6]);
            d.revparBud=num(r[7]); 
        }
        
        // ===== ç»†åˆ†é¡¹ç›®æ•°æ® =====
        const isTotal = /^Total|^Sub.*Total|åˆè®¡$/i.test(n);
        const isHeader = /^Revenue|^Statistics|^Actual|^Budget|^Forecast|^Food & Beverage|^Other Operating|^ROOM STAT/i.test(n);
        const isBanquetItem = /Banquet|å®´ä¼š|ä¼šè®®å®¤ç§Ÿé‡‘|è®¾å¤‡ç§Ÿé‡‘/i.test(n);
        
        // æ’é™¤å®´ä¼šç»†é¡¹ï¼ˆå®´ä¼šå°è®¡å·²å•ç‹¬å¤„ç†ï¼‰
        if (isBanquetItem) return;
        
        if (r.length>=10 && (num(r[6])!==0 || num(r[8])!==0) && !isTotal && !isHeader) {
            let type='Other';
            if(/Rate|Tour|Discount|Corporate|Individual|Convention|Permanent|Negotiated|Consortia|SMRF|Meeting|Government|å®¢æº/i.test(n)) {
                type='Room';
            } else if(/Kok|Brasserie|Bar|Service|Mini|ç¾¿åº­|ç™¾å‘³å›­|å»Šå§|æµ¦æ±Ÿæ±‡|è”šæ™¯é˜|å®¢æˆ¿æœåŠ¡|è¿·ä½ å§|Ling Long|Peacock|Grand|Long Bar|Salon|Room Service/i.test(n)) {
                type='F&B';
            }
            
            d.rows.push({
                name: n,
                type,
                actual: num(r[6]),
                budget: num(r[7]),
                mtdActual: num(r[8]),
                mtdBudget: num(r[10])
            });
        }
    });
    
    // è®¡ç®—å…¶ä»–æ”¶å…¥
    if (d.totals.hotel && d.totals.room && d.totals.fb && (!d.totals.other || d.totals.other.act === 0)) {
        d.totals.other = {
            act: d.totals.hotel.act - d.totals.room.act - d.totals.fb.act,
            bud: d.totals.hotel.bud - d.totals.room.bud - d.totals.fb.bud
        };
    }
    if (d.mtd.hotel && d.mtd.room && d.mtd.fb && (!d.mtd.other || d.mtd.other.act === 0)) {
        d.mtd.other = {
            act: d.mtd.hotel.act - d.mtd.room.act - d.mtd.fb.act,
            bud: d.mtd.hotel.bud - d.mtd.room.bud - d.mtd.fb.bud
        };
    }
    
    console.log('===== è§£æå®Œæˆ =====');
    console.log('ä»Šæ—¥æ•°æ®:', JSON.stringify(d.totals));
    console.log('æœˆç´¯è®¡æ•°æ®:', JSON.stringify(d.mtd));
    return d;
}

function renderDashboard(d) {
    let room=d.totals.room||{act:0,bud:0}, fb=d.totals.fb||{act:0,bud:0}, other=d.totals.other||{act:0,bud:0}, grand=d.totals.hotel||{act:0,bud:0};
    if(d.totals.hotel&&d.totals.room&&d.totals.fb){other.act=grand.act-room.act-fb.act;other.bud=grand.bud-room.bud-fb.bud;}
    
    // ä¼˜å…ˆä½¿ç”¨Excelä¸­çš„æœˆç´¯è®¡æ•°æ®d.mtd
    const mtd = d.mtd || STATE.mtdData;
    console.log('æ¸²æŸ“ä½¿ç”¨çš„MTDæ•°æ®:', mtd);
    
    document.getElementById('current-date').textContent = d.date + ' ' + (d.weekday||'');
    document.getElementById('data-status').textContent = 'å·²åŠ è½½';
    document.getElementById('data-status').className = 'tag tag-green';
    const fmt = n => 'Â¥' + Math.floor(n).toLocaleString();
    const fmtWan = n => (n/10000).toFixed(1) + 'ä¸‡';
    
    document.getElementById('kpi-revenue').textContent = fmt(grand.act);
    document.getElementById('kpi-revenue-bud').textContent = fmt(grand.bud);
    const revPct = grand.bud>0?(grand.act/grand.bud*100):100;
    document.getElementById('kpi-revenue-pct').textContent = revPct.toFixed(1)+'%';
    document.getElementById('kpi-revenue-pct').className = revPct>=100?'text-green-400 font-semibold':'text-red-400 font-semibold';
    
    let occAct=d.occupancy||0,occBud=d.occBud||0;
    if(occAct<=1)occAct*=100;if(occBud<=1)occBud*=100;
    document.getElementById('kpi-occ').textContent = occAct.toFixed(1)+'%';
    document.getElementById('kpi-occ-bud').textContent = occBud.toFixed(1)+'%';
    document.getElementById('kpi-sold').textContent = (d.roomsSold||0) + '/' + (d.roomsBud||0);
    document.getElementById('kpi-adr').textContent = 'Â¥'+Math.floor(d.adr||0);
    document.getElementById('kpi-adr-bud').textContent = 'Â¥'+Math.floor(d.adrBud||0);
    const adrPct=d.adrBud>0?(d.adr/d.adrBud*100):100;
    document.getElementById('kpi-adr-pct').textContent = adrPct.toFixed(1)+'%';
    document.getElementById('kpi-adr-pct').className = adrPct>=100?'text-green-400 font-semibold':'text-red-400 font-semibold';
    document.getElementById('kpi-revpar').textContent = 'Â¥'+Math.floor(d.revpar||0);
    document.getElementById('kpi-revpar-bud').textContent = 'Â¥'+Math.floor(d.revparBud||0);
    const revparPct=d.revparBud>0?(d.revpar/d.revparBud*100):100;
    document.getElementById('kpi-revpar-pct').textContent = revparPct.toFixed(1)+'%';
    document.getElementById('kpi-revpar-pct').className = revparPct>=100?'text-green-400 font-semibold':'text-red-400 font-semibold';
    
    const depts = [
        {name:'å®¢æˆ¿',act:room.act,bud:room.bud,icon:'ğŸ¨', mtdAct:mtd.room?.act||0, mtdBud:mtd.room?.bud||0},
        {name:'é¤é¥®',act:fb.act,bud:fb.bud,icon:'ğŸ½ï¸', mtdAct:mtd.fb?.act||0, mtdBud:mtd.fb?.bud||0},
        {name:'å…¶ä»–',act:other.act,bud:other.bud,icon:'ğŸ“¦', mtdAct:mtd.other?.act||0, mtdBud:mtd.other?.bud||0},
        {name:'åˆè®¡',act:grand.act,bud:grand.bud,icon:'ğŸ¢', mtdAct:mtd.hotel?.act||0, mtdBud:mtd.hotel?.bud||0}
    ];
    
    document.getElementById('dept-table-body').innerHTML = depts.map(dep => {
        const diff=dep.act-dep.bud, pct=dep.bud>0?(dep.act/dep.bud*100):100;
        const mtdPct = dep.mtdBud>0?(dep.mtdAct/dep.mtdBud*100):100;
        const isTotal = dep.name==='åˆè®¡';
        return `<tr class="${isTotal?'bg-zinc-800/30 font-medium':''}">
            <td>${dep.icon} ${dep.name}</td>
            <td class="font-mono">${fmt(dep.act)}</td>
            <td class="text-zinc-500 font-mono">${fmt(dep.bud)}</td>
            <td class="${diff>=0?'text-green-400':'text-red-400'} font-mono">${diff>=0?'+':''}${fmtWan(diff)}</td>
            <td class="${pct>=100?'text-green-400':pct>=90?'text-amber-400':'text-red-400'} font-medium">${pct.toFixed(1)}%</td>
            <td class="font-mono mtd-cell">Â¥${fmtWan(dep.mtdAct)}</td>
            <td class="text-zinc-500 font-mono mtd-cell">Â¥${fmtWan(dep.mtdBud)}</td>
            <td class="${mtdPct>=100?'text-green-400':mtdPct>=90?'text-amber-400':'text-red-400'} font-medium mtd-cell">${mtdPct.toFixed(1)}%</td>
        </tr>`;
    }).join('');
    
    renderMainChart(depts.slice(0,3));
    renderPieChart(depts.slice(0,3));
}

function renderMainChart(depts) {
    const el=document.getElementById('main-chart');
    if(STATE.charts.main)STATE.charts.main.dispose();
    const chart=echarts.init(el,'dark');
    chart.setOption({backgroundColor:'transparent',tooltip:{trigger:'axis'},legend:{data:['å®é™…','é¢„ç®—'],bottom:0,textStyle:{color:'#71717a',fontSize:10}},grid:{left:5,right:5,top:5,bottom:35,containLabel:true},xAxis:{type:'category',data:depts.map(d=>d.name),axisLabel:{fontSize:10,color:'#a1a1aa'}},yAxis:{type:'value',axisLabel:{fontSize:9,formatter:v=>(v/10000)+'w'},splitLine:{lineStyle:{color:'#27272a'}}},series:[{name:'å®é™…',type:'bar',data:depts.map(d=>d.act),itemStyle:{color:'#3b82f6',borderRadius:[4,4,0,0]},barWidth:20},{name:'é¢„ç®—',type:'bar',data:depts.map(d=>d.bud),itemStyle:{color:'#3f3f46',borderRadius:[4,4,0,0]},barWidth:20}]});
    STATE.charts.main=chart;
}

function renderPieChart(depts) {
    const el=document.getElementById('pie-chart');
    if(STATE.charts.pie)STATE.charts.pie.dispose();
    const chart=echarts.init(el,'dark');
    chart.setOption({backgroundColor:'transparent',tooltip:{trigger:'item',formatter:'{b}: Â¥{c} ({d}%)'},series:[{type:'pie',radius:['40%','70%'],center:['50%','50%'],itemStyle:{borderRadius:4,borderColor:'#16161a',borderWidth:2},label:{show:true,fontSize:10,color:'#a1a1aa',formatter:'{b}\n{d}%'},data:[{value:depts[0].act,name:'å®¢æˆ¿',itemStyle:{color:'#3b82f6'}},{value:depts[1].act,name:'é¤é¥®',itemStyle:{color:'#22c55e'}},{value:depts[2].act,name:'å…¶ä»–',itemStyle:{color:'#f59e0b'}}]}]});
    STATE.charts.pie=chart;
}

function renderTrendChart(data) {
    const el=document.getElementById('trend-chart');
    if(STATE.charts.trend)STATE.charts.trend.dispose();
    if(!data.length)return;
    const chart=echarts.init(el,'dark');
    chart.setOption({backgroundColor:'transparent',tooltip:{trigger:'axis',formatter:p=>p[0].name+'<br/>'+p.map(i=>i.marker+i.seriesName+': Â¥'+(i.value/10000).toFixed(1)+'ä¸‡').join('<br/>')},legend:{data:['å®é™…','é¢„ç®—'],bottom:0,textStyle:{color:'#71717a',fontSize:10}},grid:{left:5,right:5,top:10,bottom:35,containLabel:true},xAxis:{type:'category',data:data.map(d=>d.date.slice(5)),axisLabel:{fontSize:9,color:'#71717a',rotate:30}},yAxis:{type:'value',axisLabel:{fontSize:9,formatter:v=>(v/10000)+'w'},splitLine:{lineStyle:{color:'#27272a'}}},series:[{name:'å®é™…',type:'line',data:data.map(d=>d.totals?.hotel?.act||0),smooth:true,symbol:'circle',symbolSize:4,lineStyle:{color:'#3b82f6',width:2},itemStyle:{color:'#3b82f6'},areaStyle:{color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:'rgba(59,130,246,0.3)'},{offset:1,color:'rgba(59,130,246,0)'}]}}},{name:'é¢„ç®—',type:'line',data:data.map(d=>d.totals?.hotel?.bud||0),smooth:true,symbol:'none',lineStyle:{color:'#71717a',width:1,type:'dashed'}}]});
    STATE.charts.trend=chart;
}

function renderOpsTrendChart(data) {
    const el=document.getElementById('ops-trend-chart');
    if(STATE.charts.opsTrend)STATE.charts.opsTrend.dispose();
    if(!data.length||!data.some(d=>d.revpar||d.adr||d.occupancy)){el.innerHTML='<div class="flex items-center justify-center h-full text-zinc-600 text-xs">æš‚æ— æ•°æ®</div>';return;}
    const chart=echarts.init(el,'dark');
    chart.setOption({backgroundColor:'transparent',tooltip:{trigger:'axis'},legend:{data:['RevPAR','ADR','å…¥ä½ç‡'],bottom:0,textStyle:{color:'#71717a',fontSize:10}},grid:{left:5,right:35,top:10,bottom:35,containLabel:true},xAxis:{type:'category',data:data.map(d=>d.date.slice(5)),axisLabel:{fontSize:9,color:'#71717a',rotate:30}},yAxis:[{type:'value',position:'left',axisLabel:{fontSize:9,formatter:v=>'Â¥'+v},splitLine:{lineStyle:{color:'#27272a'}}},{type:'value',position:'right',min:0,max:100,axisLabel:{fontSize:9,formatter:v=>v+'%'},splitLine:{show:false}}],series:[{name:'RevPAR',type:'line',yAxisIndex:0,data:data.map(d=>Math.floor(d.revpar||0)),smooth:true,symbol:'circle',symbolSize:4,lineStyle:{color:'#a855f7',width:2},itemStyle:{color:'#a855f7'}},{name:'ADR',type:'line',yAxisIndex:0,data:data.map(d=>Math.floor(d.adr||0)),smooth:true,symbol:'circle',symbolSize:4,lineStyle:{color:'#f59e0b',width:2},itemStyle:{color:'#f59e0b'}},{name:'å…¥ä½ç‡',type:'line',yAxisIndex:1,data:data.map(d=>{const o=d.occupancy||0;return o<=1?(o*100).toFixed(1):o.toFixed(1);}),smooth:true,symbol:'circle',symbolSize:4,lineStyle:{color:'#22c55e',width:2},itemStyle:{color:'#22c55e'},areaStyle:{color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:'rgba(34,197,94,0.2)'},{offset:1,color:'rgba(34,197,94,0)'}]}}}]});
    STATE.charts.opsTrend=chart;
}

async function generateAIAnalysis() {
    if(!STATE.currentData)return;
    const dailyPanel = document.getElementById('ai-panel-daily');
    const monthlyPanel = document.getElementById('ai-panel-monthly');
    
    const loadingHtml = '<div class="flex flex-col items-center justify-center py-12"><div class="ai-loading"><div class="spinner"></div></div><p class="text-zinc-500 text-xs mt-3">AIåˆ†æä¸­...</p></div>';
    dailyPanel.innerHTML = loadingHtml;
    monthlyPanel.innerHTML = loadingHtml;
    
    try {
        const d = STATE.currentData;
        const room=d.totals?.room||{act:0,bud:0}, fb=d.totals?.fb||{act:0,bud:0}, other=d.totals?.other||{act:0,bud:0}, hotel=d.totals?.hotel||{act:0,bud:0};
        
        const totalPct=hotel.bud>0?(hotel.act/hotel.bud*100).toFixed(1):'100';
        const roomPct=room.bud>0?(room.act/room.bud*100).toFixed(1):'100';
        const fbPct=fb.bud>0?(fb.act/fb.bud*100).toFixed(1):'100';
        const otherPct=other.bud>0?(other.act/other.bud*100).toFixed(1):'100';
        let occ=d.occupancy||0; if(occ<=1) occ*=100;
        let occBud=d.occBud||0; if(occBud<=1) occBud*=100;
        
        // æ•´ç†ä»Šæ—¥ç»†åˆ†é¡¹ç›®æ•°æ®
        const rows = d.rows || [];
        const formatDetails = (types) => {
            const items = rows.filter(r => types.includes(r.type));
            if (items.length === 0) return 'æš‚æ— æ•°æ®';
            return items.map(r => {
                const pct = r.budget > 0 ? (r.actual / r.budget * 100).toFixed(0) : 100;
                return `${getChineseName(r.name)}: å®é™…Â¥${r.actual.toLocaleString()} / é¢„ç®—Â¥${r.budget.toLocaleString()} = ${pct}%`;
            }).join('\n');
        };
        
        // æ•´ç†æœˆç´¯è®¡ç»†åˆ†é¡¹ç›®æ•°æ®
        const formatMtdDetails = (types) => {
            const items = rows.filter(r => types.includes(r.type) && r.mtdActual !== undefined);
            if (items.length === 0) return 'æš‚æ— æ•°æ®';
            return items.map(r => {
                const pct = r.mtdBudget > 0 ? (r.mtdActual / r.mtdBudget * 100).toFixed(0) : 100;
                return `${getChineseName(r.name)}: æœˆç´¯è®¡å®é™…Â¥${Math.round(r.mtdActual).toLocaleString()} / é¢„ç®—Â¥${Math.round(r.mtdBudget).toLocaleString()} = ${pct}%`;
            }).join('\n');
        };
        
        const roomDetails = formatDetails(['Room']);
        const fbDetails = formatDetails(['F&B']);
        const otherDetails = formatDetails(['Other']);
        
        const mtdRoomDetails = formatMtdDetails(['Room']);
        const mtdFbDetails = formatMtdDetails(['F&B']);
        const mtdOtherDetails = formatMtdDetails(['Other']);
        
        // ä¼˜å…ˆä½¿ç”¨Excelä¸­çš„æœˆç´¯è®¡æ•°æ®d.mtd
        const mtd = d.mtd || STATE.mtdData;
        const mtdTotalPct = mtd.hotel?.bud>0?(mtd.hotel.act/mtd.hotel.bud*100).toFixed(1):'100';
        const mtdRoomPct = mtd.room?.bud>0?(mtd.room.act/mtd.room.bud*100).toFixed(1):'100';
        const mtdFbPct = mtd.fb?.bud>0?(mtd.fb.act/mtd.fb.bud*100).toFixed(1):'100';
        const mtdOtherPct = mtd.other?.bud>0?(mtd.other.act/mtd.other.bud*100).toFixed(1):'100';
        
        const dayOfMonth = parseInt(d.date.split('-')[2]);
        const daysInMonth = new Date(d.date.split('-')[0], d.date.split('-')[1], 0).getDate();
        const timeProgress = (dayOfMonth / daysInMonth * 100).toFixed(1);
        
        // ä»Šæ—¥åˆ†ææç¤ºè¯
        const dailyPrompt = STATE.aiPromptDaily
            .replace(/{date}/g, d.date)
            .replace(/{total_pct}/g, totalPct)
            .replace(/{room_pct}/g, roomPct)
            .replace(/{fb_pct}/g, fbPct)
            .replace(/{other_pct}/g, otherPct)
            .replace(/{occupancy}/g, occ.toFixed(1))
            .replace(/{occ_bud}/g, occBud.toFixed(1))
            .replace(/{adr}/g, Math.floor(d.adr||0))
            .replace(/{adr_bud}/g, Math.floor(d.adrBud||0))
            .replace(/{revpar}/g, Math.floor(d.revpar||0))
            .replace(/{revpar_bud}/g, Math.floor(d.revparBud||0))
            .replace(/{room_details}/g, roomDetails)
            .replace(/{fb_details}/g, fbDetails)
            .replace(/{other_details}/g, otherDetails);
        
        // æœˆåº¦åˆ†ææç¤ºè¯
        const monthlyPrompt = STATE.aiPromptMonthly
            .replace(/{date}/g, d.date)
            .replace(/{day_of_month}/g, dayOfMonth)
            .replace(/{time_progress}/g, timeProgress)
            .replace(/{mtd_total_pct}/g, mtdTotalPct)
            .replace(/{mtd_room_pct}/g, mtdRoomPct)
            .replace(/{mtd_fb_pct}/g, mtdFbPct)
            .replace(/{mtd_other_pct}/g, mtdOtherPct)
            .replace(/{mtd_total_act}/g, ((mtd.hotel?.act||0)/10000).toFixed(1))
            .replace(/{mtd_total_bud}/g, ((mtd.hotel?.bud||0)/10000).toFixed(1))
            .replace(/{mtd_variance}/g, (((mtd.hotel?.act||0) - (mtd.hotel?.bud||0))/10000).toFixed(1))
            .replace(/{mtd_room_details}/g, mtdRoomDetails)
            .replace(/{mtd_fb_details}/g, mtdFbDetails)
            .replace(/{mtd_other_details}/g, mtdOtherDetails);
        
        const [dailyRes, monthlyRes] = await Promise.all([
            fetch(STATE.qianwen.endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + STATE.qianwen.apiKey },
                body: JSON.stringify({ model: STATE.qianwen.model, messages: [{role:'user', content: dailyPrompt}], temperature: 0.5, max_tokens: 1500 })
            }),
            fetch(STATE.qianwen.endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + STATE.qianwen.apiKey },
                body: JSON.stringify({ model: STATE.qianwen.model, messages: [{role:'user', content: monthlyPrompt}], temperature: 0.5, max_tokens: 1500 })
            })
        ]);
        
        if (!dailyRes.ok || !monthlyRes.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
        
        const dailyResult = await dailyRes.json();
        const monthlyResult = await monthlyRes.json();
        
        let dailyContent = dailyResult.choices[0].message.content;
        let monthlyContent = monthlyResult.choices[0].message.content;
        
        dailyContent = dailyContent.replace(/```html\n?/gi,'').replace(/```\n?/g,'').trim();
        monthlyContent = monthlyContent.replace(/```html\n?/gi,'').replace(/```\n?/g,'').trim();
        
        dailyPanel.innerHTML = dailyContent;
        monthlyPanel.innerHTML = monthlyContent;
        
        STATE.currentData.aiAnalysisDaily = dailyContent;
        STATE.currentData.aiAnalysisMonthly = monthlyContent;
        STATE.currentData.aiAnalysisTime = new Date().toLocaleString('zh-CN');
        document.getElementById('ai-update-time').textContent = STATE.currentData.aiAnalysisTime;
        
        showToast('AIåˆ†æå®Œæˆï¼Œè¯·ç‚¹å‡»ä¿å­˜æŒ‰é’®ä¿å­˜åˆ†æç»“æœ', 'success');
        
    } catch(e) { 
        console.error(e); 
        const errorHtml = '<div class="text-center py-12 text-zinc-600"><i class="fa-solid fa-exclamation-circle text-2xl mb-3"></i><p class="text-xs">AIåˆ†æå¤±è´¥</p></div>';
        dailyPanel.innerHTML = errorHtml;
        monthlyPanel.innerHTML = errorHtml;
        showToast('AIåˆ†æå¤±è´¥', 'error');
    }
}

function openDeepDive(){document.getElementById('deep-modal').classList.remove('hidden');switchDeepTab('room');}
function switchDeepTab(tab) {
    ['room','fb','other'].forEach(t=>{const b=document.getElementById('deep-tab-'+t);if(b){b.classList.toggle('bg-zinc-700',t===tab);b.classList.toggle('text-zinc-400',t!==tab);}});
    if(!STATE.currentData)return;
    const typeMap={room:['Room'],fb:['F&B'],other:['Other']};
    let rows=STATE.currentData.rows.filter(r=>typeMap[tab].includes(r.type));
    rows=rows.filter(r=>!/Total|åˆè®¡/i.test(r.name)).sort((a,b)=>b.actual-a.actual);
    document.getElementById('deep-table-head').innerHTML='<tr><th>é¡¹ç›®</th><th>å®é™…</th><th>é¢„ç®—</th><th>å®Œæˆç‡</th></tr>';
    document.getElementById('deep-table-body').innerHTML=rows.map(r=>{const p=r.budget>0?(r.actual/r.budget*100):100;return '<tr><td>'+getChineseName(r.name)+'</td><td class="font-mono">Â¥'+r.actual.toLocaleString()+'</td><td class="text-zinc-500 font-mono">Â¥'+r.budget.toLocaleString()+'</td><td class="'+(p>=100?'text-green-400':p>=80?'text-amber-400':'text-red-400')+'">'+p.toFixed(0)+'%</td></tr>';}).join('');
    const el=document.getElementById('deep-chart');
    if(STATE.charts.deep)STATE.charts.deep.dispose();
    const chart=echarts.init(el,'dark'),top=rows.slice(0,10);
    chart.setOption({backgroundColor:'transparent',tooltip:{trigger:'axis'},legend:{data:['å®é™…','é¢„ç®—'],bottom:0,textStyle:{color:'#71717a',fontSize:10}},grid:{left:5,right:5,top:5,bottom:40,containLabel:true},xAxis:{type:'category',data:top.map(r=>getChineseName(r.name)),axisLabel:{rotate:35,fontSize:9,color:'#a1a1aa'}},yAxis:{type:'value',axisLabel:{fontSize:9},splitLine:{lineStyle:{color:'#27272a'}}},series:[{name:'å®é™…',type:'bar',data:top.map(r=>r.actual),itemStyle:{color:'#3b82f6',borderRadius:[4,4,0,0]},barWidth:16},{name:'é¢„ç®—',type:'bar',data:top.map(r=>r.budget),itemStyle:{color:'#3f3f46',borderRadius:[4,4,0,0]},barWidth:16}]});
    STATE.charts.deep=chart;
    const totalAct=rows.reduce((s,r)=>s+r.actual,0),totalBud=rows.reduce((s,r)=>s+r.budget,0);
    const totalPct=totalBud>0?(totalAct/totalBud*100).toFixed(1):100;
    
    // åˆ†æå®Œæˆå¥½çš„å’Œå®Œæˆä¸å¥½çš„é¡¹ç›®
    const goodItems = rows.filter(r => r.budget > 0 && (r.actual / r.budget * 100) >= 100).sort((a,b) => (b.actual/b.budget) - (a.actual/a.budget));
    const badItems = rows.filter(r => r.budget > 0 && (r.actual / r.budget * 100) < 80).sort((a,b) => (a.actual/a.budget) - (b.actual/b.budget));
    
    let summaryHtml = '<p><strong>æ•´ä½“å®Œæˆç‡ï¼š<span class="'+(parseFloat(totalPct)>=100?'text-green-400':'text-red-400')+'">'+totalPct+'%</span></strong> | å®é™… Â¥'+(totalAct/10000).toFixed(1)+'ä¸‡ / é¢„ç®— Â¥'+(totalBud/10000).toFixed(1)+'ä¸‡</p>';
    
    if (goodItems.length > 0) {
        summaryHtml += '<p class="mt-2"><span class="text-green-400">âœ“ å®Œæˆè¾ƒå¥½ï¼š</span>';
        summaryHtml += goodItems.map(r => {
            const pct = (r.actual / r.budget * 100).toFixed(0);
            return getChineseName(r.name) + ' <span class="text-green-400">' + pct + '%</span>';
        }).join('ã€');
        summaryHtml += '</p>';
    }
    
    if (badItems.length > 0) {
        summaryHtml += '<p class="mt-1"><span class="text-red-400">âœ— éœ€è¦æ”¹è¿›ï¼š</span>';
        summaryHtml += badItems.map(r => {
            const pct = (r.actual / r.budget * 100).toFixed(0);
            return getChineseName(r.name) + ' <span class="text-red-400">' + pct + '%</span>';
        }).join('ã€');
        summaryHtml += '</p>';
    }
    
    document.getElementById('deep-summary-content').innerHTML = summaryHtml;
}

window.addEventListener('resize',()=>Object.values(STATE.charts).forEach(c=>c?.resize()));
document.addEventListener('DOMContentLoaded',()=>{console.log('ğŸš€ NEXUS v2.6 æœˆç´¯è®¡ç‰ˆå¯åŠ¨');refreshData();});
</script>
</body>
</html>
