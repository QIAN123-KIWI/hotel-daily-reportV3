<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—ç»è¥æ—¥æŠ¥ | NEXUS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #111114;
            --bg-card: #16161a;
            --border-color: #232329;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-amber: #f59e0b;
            --accent-purple: #a855f7;
            --accent-red: #ef4444;
        }
        
        body { 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif; 
            font-size: 13px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            transition: all 0.2s;
        }
        .card:hover {
            border-color: #333;
        }
        
        .kpi-card { 
            padding: 14px 16px; 
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
        }
        .kpi-card.blue::before { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
        .kpi-card.green::before { background: linear-gradient(180deg, #22c55e, #16a34a); }
        .kpi-card.amber::before { background: linear-gradient(180deg, #f59e0b, #d97706); }
        .kpi-card.purple::before { background: linear-gradient(180deg, #a855f7, #7c3aed); }
        
        .kpi-value { 
            font-size: 1.25rem; 
            font-weight: 600; 
            font-family: 'JetBrains Mono', monospace; 
            letter-spacing: -0.02em;
        }
        
        .tag { 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 10px; 
            font-weight: 600; 
        }
        .tag-green { background: rgba(34,197,94,0.12); color: #4ade80; }
        .tag-red { background: rgba(239,68,68,0.12); color: #f87171; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-muted); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .sidebar { width: 200px; transition: width 0.2s; }
        .sidebar.collapsed { width: 48px; }
        .sidebar.collapsed .sidebar-content { display: none; }
        .sidebar.collapsed .sidebar-toggle i { transform: rotate(180deg); }
        
        .history-item { 
            padding: 8px 10px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 12px; 
            transition: all 0.15s;
        }
        .history-item:hover { background: rgba(255,255,255,0.05); }
        .history-item.active { 
            background: rgba(59,130,246,0.1); 
            border-left: 2px solid var(--accent-blue); 
        }
        .month-content { max-height: 0; overflow: hidden; transition: max-height 0.2s; }
        .month-content.expanded { max-height: 400px; }
        
        #toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; }
        .toast { 
            padding: 10px 16px; 
            border-radius: 8px; 
            font-size: 12px; 
            margin-bottom: 8px; 
            animation: slideIn 0.25s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast-success { background: linear-gradient(135deg, #166534, #15803d); }
        .toast-error { background: linear-gradient(135deg, #991b1b, #b91c1c); }
        .toast-info { background: linear-gradient(135deg, #1e40af, #2563eb); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        
        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        
        /* AI åˆ†ææ ·å¼ */
        #ai-analysis { font-size: 12px; line-height: 1.7; }
        #ai-analysis .section-title { 
            color: var(--accent-blue); 
            font-size: 12px; 
            font-weight: 600; 
            margin: 14px 0 8px 0; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        #ai-analysis .section-title:first-child { margin-top: 0; }
        #ai-analysis p { color: var(--text-secondary); margin: 6px 0; }
        #ai-analysis strong { color: var(--text-primary); }
        #ai-analysis .highlight-good { color: #4ade80; }
        #ai-analysis .highlight-bad { color: #f87171; }
        #ai-analysis .highlight-warn { color: #fbbf24; }
        #ai-analysis .data-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        #ai-analysis .data-row:last-child { border-bottom: none; }
        #ai-analysis .sub-item { 
            padding-left: 16px; 
            font-size: 11px; 
            color: var(--text-muted);
            border-left: 2px solid var(--border-color);
            margin: 4px 0 4px 8px;
        }
        #ai-analysis .progress-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        #ai-analysis .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        #ai-analysis .risk-item {
            background: rgba(239,68,68,0.08);
            border-left: 3px solid var(--accent-red);
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 0 6px 6px 0;
        }
        #ai-analysis .suggestion-item {
            background: rgba(34,197,94,0.08);
            border-left: 3px solid var(--accent-green);
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .ai-loading .spinner { 
            width: 16px; 
            height: 16px; 
            border: 2px solid var(--accent-blue); 
            border-top-color: transparent; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .deep-summary { 
            background: var(--bg-secondary); 
            border-radius: 8px; 
            padding: 16px; 
            margin-top: 16px; 
            font-size: 12px; 
        }
        .deep-summary .good { color: #4ade80; }
        .deep-summary .bad { color: #f87171; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        /* æç¤ºè¯ç¼–è¾‘é¢æ¿ */
        .prompt-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .prompt-panel.collapsed {
            max-height: 40px;
        }
        .prompt-panel.expanded {
            max-height: 400px;
        }
        .prompt-header {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background: var(--bg-card);
        }
        .prompt-header:hover {
            background: var(--border-color);
        }
        .prompt-body {
            padding: 12px;
            display: none;
        }
        .prompt-panel.expanded .prompt-body {
            display: block;
        }
        .prompt-textarea {
            width: 100%;
            height: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            resize: none;
            line-height: 1.5;
        }
        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* åˆ†æçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .analysis-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.active {
            background: var(--accent-green);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="toast-container"></div>

    <div class="flex min-h-screen">
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class="sidebar border-r border-zinc-800/50 p-3 flex flex-col bg-[#0c0c0e]">
            <button onclick="toggleSidebar()" class="sidebar-toggle w-full flex items-center justify-center py-2 mb-3 text-zinc-500 hover:text-white text-xs rounded-lg hover:bg-zinc-800/50 transition-colors">
                <i class="fa-solid fa-chevron-left transition-transform duration-200"></i>
            </button>
            <div class="sidebar-content flex flex-col flex-1">
                <div class="flex items-center gap-3 mb-4 px-1">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <i class="fa-solid fa-chart-line text-white text-sm"></i>
                    </div>
                    <div>
                        <span class="font-semibold text-white text-sm block">NEXUS</span>
                        <span class="text-[10px] text-zinc-500">ç»è¥åˆ†æç³»ç»Ÿ</span>
                    </div>
                </div>
                <label class="block mb-4">
                    <div class="w-full py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 rounded-lg cursor-pointer text-center text-xs font-medium transition-all hover:shadow-lg hover:shadow-blue-500/20">
                        <i class="fa-solid fa-upload mr-2"></i>ä¸Šä¼ æŠ¥è¡¨
                    </div>
                    <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" class="hidden">
                </label>
                <div class="flex items-center justify-between mb-2 px-1">
                    <span class="text-[10px] text-zinc-500 uppercase tracking-wider">å†å²è®°å½•</span>
                    <span class="text-[10px] text-zinc-600 bg-zinc-800/50 px-2 py-0.5 rounded" id="history-count">0</span>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto"></div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="flex-1 p-4 overflow-y-auto">
            <!-- é¡¶éƒ¨ -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <span id="current-date" class="text-lg font-semibold text-white">--</span>
                    <span id="data-status" class="tag tag-red">æ— æ•°æ®</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="refreshFromGitHub()" class="btn-secondary px-3 py-1.5">
                        <i class="fa-solid fa-sync"></i>
                    </button>
                    <button id="save-btn" onclick="saveToGitHub()" disabled class="btn-primary px-4 py-1.5">
                        <i class="fa-solid fa-cloud-arrow-up mr-1.5"></i>ä¿å­˜åˆ°äº‘ç«¯
                    </button>
                    <button onclick="openSettingsModal()" class="btn-secondary px-3 py-1.5">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>

            <!-- KPI -->
            <div class="grid grid-cols-4 gap-3 mb-4">
                <div class="card kpi-card blue">
                    <p class="text-[10px] text-zinc-500 mb-1">æ€»è¥æ”¶ Total Revenue</p>
                    <p id="kpi-revenue" class="kpi-value text-white">--</p>
                    <p class="text-[10px] text-zinc-500 mt-1">é¢„ç®— <span id="kpi-revenue-bud" class="font-mono">--</span> <span id="kpi-revenue-tag" class="tag">--</span></p>
                </div>
                <div class="card kpi-card green">
                    <p class="text-[10px] text-zinc-500 mb-1">å‡ºç§Ÿç‡ Occupancy</p>
                    <p id="kpi-occ" class="kpi-value text-white">--</p>
                    <p class="text-[10px] text-zinc-500 mt-1">å”®æˆ¿ <span id="kpi-sold" class="font-mono">--</span>/260</p>
                </div>
                <div class="card kpi-card amber">
                    <p class="text-[10px] text-zinc-500 mb-1">ADR å¹³å‡æˆ¿ä»·</p>
                    <p id="kpi-adr" class="kpi-value text-white">--</p>
                    <p class="text-[10px] text-zinc-500 mt-1">é¢„ç®— <span id="kpi-adr-bud" class="font-mono">--</span></p>
                </div>
                <div class="card kpi-card purple">
                    <p class="text-[10px] text-zinc-500 mb-1">RevPAR æ¯æˆ¿æ”¶ç›Š</p>
                    <p id="kpi-revpar" class="kpi-value text-white">--</p>
                    <p class="text-[10px] text-zinc-500 mt-1">é¢„ç®— <span id="kpi-revpar-bud" class="font-mono">--</span></p>
                </div>
            </div>

            <!-- ä¸»åŒºåŸŸï¼šè°ƒæ•´æ¯”ä¾‹ 7:5 -->
            <div class="grid grid-cols-12 gap-4 mb-4">
                <!-- å·¦ä¾§ï¼šæ•°æ®å±•ç¤ºåŒºåŸŸï¼ˆæ‰©å¤§ï¼‰ -->
                <div class="col-span-7 flex flex-col gap-4">
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-zinc-300">
                                <i class="fa-solid fa-layer-group text-blue-400 mr-2"></i>éƒ¨é—¨æ¦‚è§ˆ
                            </span>
                            <button onclick="openDeepDive()" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                                <i class="fa-solid fa-table-list"></i>æŸ¥çœ‹è¯¦ç»†æ•°æ®
                            </button>
                        </div>
                        <table>
                            <thead><tr><th>éƒ¨é—¨</th><th>å®é™…æ”¶å…¥</th><th>é¢„ç®—é‡‘é¢</th><th>å·®é¢</th><th>å®Œæˆç‡</th></tr></thead>
                            <tbody id="dept-table-body"><tr><td colspan="5" class="text-center text-zinc-600 py-4">--</td></tr></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card p-4">
                            <span class="text-sm font-medium text-zinc-300">
                                <i class="fa-solid fa-chart-bar text-blue-400 mr-2"></i>è¥æ”¶å¯¹æ¯”
                            </span>
                            <div id="main-chart" style="height:160px;"></div>
                        </div>
                        <div class="card p-4">
                            <span class="text-sm font-medium text-zinc-300">
                                <i class="fa-solid fa-chart-pie text-amber-400 mr-2"></i>æ”¶å…¥æ„æˆ
                            </span>
                            <div id="pie-chart" style="height:160px;"></div>
                        </div>
                    </div>
                    <!-- å†å²è¶‹åŠ¿ï¼šåˆ†æˆä¸¤ä¸ªå›¾ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card p-4">
                            <span class="text-sm font-medium text-zinc-300">
                                <i class="fa-solid fa-chart-line text-green-400 mr-2"></i>è¥æ”¶è¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰
                            </span>
                            <div id="trend-chart" style="height:140px;"></div>
                        </div>
                        <div class="card p-4">
                            <span class="text-sm font-medium text-zinc-300">
                                <i class="fa-solid fa-hotel text-purple-400 mr-2"></i>è¿è¥æŒ‡æ ‡è¶‹åŠ¿
                            </span>
                            <div id="ops-trend-chart" style="height:140px;"></div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šAIåˆ†æï¼ˆç¼©å°ï¼‰ -->
                <div class="col-span-5">
                    <div class="card p-4 h-full flex flex-col">
                        <div class="flex items-center justify-between mb-3 pb-3 border-b border-zinc-800">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                    <i class="fa-solid fa-robot text-white text-xs"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-white block">AI ç»è¥åˆ†æ</span>
                                    <div class="analysis-status">
                                        <span class="status-dot" id="ai-status-dot"></span>
                                        <span id="ai-update-time">--</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="generateAIAnalysis()" class="btn-secondary px-3 py-1.5 text-xs" title="é‡æ–°åˆ†æ">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                        <div id="ai-analysis" class="flex-1 overflow-y-auto pr-1" style="max-height: 520px;">
                            <div class="flex flex-col items-center justify-center py-12 text-zinc-600">
                                <i class="fa-solid fa-wand-magic-sparkles text-2xl mb-3"></i>
                                <span class="text-xs">ä¸Šä¼ æ•°æ®åè‡ªåŠ¨ç”Ÿæˆæ™ºèƒ½åˆ†æ</span>
                            </div>
                        </div>
                        
                        <!-- æç¤ºè¯ç¼–è¾‘é¢æ¿ -->
                        <div id="prompt-panel" class="prompt-panel collapsed">
                            <div class="prompt-header" onclick="togglePromptPanel()">
                                <span class="text-xs text-zinc-400 flex items-center gap-2">
                                    <i class="fa-solid fa-sliders"></i>è‡ªå®šä¹‰åˆ†ææç¤ºè¯
                                </span>
                                <i class="fa-solid fa-chevron-down text-zinc-500 text-xs transition-transform" id="prompt-chevron"></i>
                            </div>
                            <div class="prompt-body">
                                <textarea id="inline-prompt" class="prompt-textarea" placeholder="åœ¨æ­¤ç¼–è¾‘AIåˆ†ææç¤ºè¯..."></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <button onclick="resetInlinePrompt()" class="text-xs text-zinc-500 hover:text-zinc-300">
                                        <i class="fa-solid fa-rotate-left mr-1"></i>æ¢å¤é»˜è®¤
                                    </button>
                                    <button onclick="applyPromptAndAnalyze()" class="btn-primary px-3 py-1.5 text-xs">
                                        <i class="fa-solid fa-play mr-1"></i>åº”ç”¨å¹¶é‡æ–°åˆ†æ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center">
        <div class="bg-zinc-900 rounded-xl p-5 w-full max-w-2xl border border-zinc-700 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-gear text-blue-400"></i>ç³»ç»Ÿè®¾ç½®
                </h3>
                <button onclick="closeModal('settings-modal')" class="text-zinc-500 hover:text-white text-lg transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="text-[10px] text-zinc-500 uppercase tracking-wider">Webhook URL</label>
                    <input type="text" id="settings-webhook" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-[10px] text-zinc-500 uppercase tracking-wider">GitHub ä»“åº“ (owner/repo)</label>
                    <input type="text" id="settings-github-repo" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-blue-500">
                </div>
            </div>
            <div class="mb-4">
                <label class="text-[10px] text-zinc-500 uppercase tracking-wider">AI åˆ†ææç¤ºè¯</label>
                <textarea id="settings-ai-prompt" rows="16" class="w-full mt-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 leading-relaxed focus:outline-none focus:border-blue-500"></textarea>
            </div>
            <div class="flex justify-between">
                <button onclick="resetPrompt()" class="btn-secondary px-3 py-2">
                    <i class="fa-solid fa-rotate-left mr-1"></i>æ¢å¤é»˜è®¤æç¤ºè¯
                </button>
                <div class="flex gap-2">
                    <button onclick="closeModal('settings-modal')" class="btn-secondary px-4 py-2">å–æ¶ˆ</button>
                    <button onclick="saveSettings()" class="btn-primary px-4 py-2">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·±åº¦åˆ†æ -->
    <div id="deep-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex flex-col">
        <div class="h-12 px-4 border-b border-zinc-800 flex items-center justify-between bg-[#0c0c0e]">
            <div class="flex items-center gap-3">
                <button onclick="closeModal('deep-modal')" class="text-zinc-400 hover:text-white text-sm flex items-center gap-2 transition-colors">
                    <i class="fa-solid fa-arrow-left"></i>è¿”å›
                </button>
                <span class="text-sm font-medium text-white">æ·±åº¦åˆ†æ - æ”¶å…¥æ˜ç»†</span>
            </div>
            <div class="flex gap-2">
                <button id="deep-tab-room" onclick="switchDeepTab('room')" class="px-4 py-1.5 rounded-lg text-xs bg-zinc-700 text-white transition-colors">å®¢æˆ¿æ”¶å…¥</button>
                <button id="deep-tab-fb" onclick="switchDeepTab('fb')" class="px-4 py-1.5 rounded-lg text-xs text-zinc-400 hover:text-white transition-colors">é¤é¥®æ”¶å…¥</button>
                <button id="deep-tab-other" onclick="switchDeepTab('other')" class="px-4 py-1.5 rounded-lg text-xs text-zinc-400 hover:text-white transition-colors">å…¶ä»–æ”¶å…¥</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-[#09090b]">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="text-sm font-medium text-zinc-300 mb-3">
                            <i class="fa-solid fa-table text-blue-400 mr-2"></i>æ”¶å…¥æ˜ç»†è¡¨
                        </h4>
                        <div class="overflow-auto max-h-80">
                            <table><thead id="deep-table-head"></thead><tbody id="deep-table-body"></tbody></table>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="text-sm font-medium text-zinc-300 mb-3">
                            <i class="fa-solid fa-chart-bar text-blue-400 mr-2"></i>æ”¶å…¥æ’è¡Œå‰10å
                        </h4>
                        <div id="deep-chart" style="height:260px;"></div>
                    </div>
                </div>
                <div class="deep-summary" id="deep-summary">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fa-solid fa-lightbulb text-amber-400"></i>
                        <span class="text-sm font-medium text-white">æ•°æ®åˆ†ææ‘˜è¦</span>
                    </div>
                    <div id="deep-summary-content" class="text-zinc-400">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¢å¼ºç‰ˆæç¤ºè¯
        const DEFAULT_AI_PROMPT = `ä½ æ˜¯ä¸“ä¸šçš„é…’åº—ç»è¥åˆ†æå¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ç»è¥æ•°æ®ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚

ã€ä»Šæ—¥ç»è¥æ¦‚å†µã€‘
æ—¥æœŸï¼š{date}ï¼ˆæœ¬æœˆç¬¬{day}å¤©ï¼Œæ—¶é—´è¿›åº¦{time_progress}%ï¼‰
ä»Šæ—¥ç›ˆäºï¼š{profit_status}{profit_amount}ä¸‡å…ƒ
æ•´ä½“å®Œæˆç‡ï¼š{total_pct}%

ã€æ”¶å…¥å®Œæˆæƒ…å†µã€‘
- å®¢æˆ¿æ”¶å…¥ï¼šå®é™…{room_act}ä¸‡ï¼Œé¢„ç®—{room_bud}ä¸‡ï¼Œå®Œæˆç‡{room_pct}%ï¼Œå·®é¢{room_diff}ï¼ˆ{room_status}ï¼‰
- é¤é¥®æ”¶å…¥ï¼šå®é™…{fb_act}ä¸‡ï¼Œé¢„ç®—{fb_bud}ä¸‡ï¼Œå®Œæˆç‡{fb_pct}%ï¼Œå·®é¢{fb_diff}ï¼ˆ{fb_status}ï¼‰  
- å…¶ä»–æ”¶å…¥ï¼šå®é™…{other_act}ä¸‡ï¼Œé¢„ç®—{other_bud}ä¸‡ï¼Œå®Œæˆç‡{other_pct}%ï¼Œå·®é¢{other_diff}ï¼ˆ{other_status}ï¼‰

ã€è¿è¥æŒ‡æ ‡ã€‘
- å…¥ä½ç‡ï¼š{occupancy}%ï¼ˆé¢„ç®—{occ_bud}%ï¼Œ{occ_status}ï¼‰
- å”®æˆ¿ï¼š{roomsSold}é—´ï¼ˆé¢„ç®—{rooms_bud}é—´ï¼‰
- ADRå¹³å‡æˆ¿ä»·ï¼šÂ¥{adr}
- RevPARï¼šÂ¥{revpar}

ã€å„é¡¹æ”¶å…¥æ˜ç»†ã€‘
{details}

ã€åˆ†æè¦æ±‚ - è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºã€‘

1. é¢„ç®—æ‰§è¡Œæ€»è§ˆï¼ˆç”¨æˆ‘æä¾›çš„å®Œæˆç‡æ•°æ®ï¼šæ•´ä½“{total_pct}%ï¼Œå®¢æˆ¿{room_pct}%ï¼Œé¤é¥®{fb_pct}%ï¼Œå…¶ä»–{other_pct}%ï¼‰
2. å®¢æˆ¿åˆ†æï¼šå“ªäº›æ¸ é“/æˆ¿å‹è¡¨ç°å¥½ï¼ˆ>100%ï¼‰ï¼Œå“ªäº›å·®ï¼ˆ<80%ï¼‰ï¼Œåˆ†æåŸå› å¹¶ç»™å‡ºå»ºè®®
3. é¤é¥®åˆ†æï¼šå“ªäº›é¤å…è¡¨ç°å¥½ï¼Œå“ªäº›å·®ï¼Œåˆ†æåŸå› å¹¶ç»™å‡ºå»ºè®®
4. å…¶ä»–æ”¶å…¥åˆ†æ
5. é£é™©é¢„è­¦ï¼šæŒ‡å‡ºéœ€è¦é‡ç‚¹å…³æ³¨çš„é—®é¢˜
6. æœˆåº¦è¿›å±•é¢„æµ‹ï¼šåŸºäºå½“å‰è¿›åº¦é¢„æµ‹æœˆåº•å®Œæˆæƒ…å†µ

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
ä½¿ç”¨HTMLæ ¼å¼ï¼Œç¦æ­¢ä½¿ç”¨Markdownã€‚å‚è€ƒä»¥ä¸‹ç»“æ„ï¼š

<div class="section-title">ğŸ“Š é¢„ç®—æ‰§è¡Œæ€»è§ˆ</div>
<p><strong>æ•´ä½“å®Œæˆç‡ï¼š{total_pct}%</strong></p>
<div class="progress-bar"><div class="progress-fill" style="width:{total_pct_bar}%;background:{total_color}"></div></div>
<div class="data-row"><span>å®¢æˆ¿æ”¶å…¥</span><span class="{room_class}">å®Œæˆ{room_pct}%</span></div>
<div class="data-row"><span>é¤é¥®æ”¶å…¥</span><span class="{fb_class}">å®Œæˆ{fb_pct}%</span></div>
<div class="data-row"><span>å…¶ä»–æ”¶å…¥</span><span class="{other_class}">å®Œæˆ{other_pct}%</span></div>

<div class="section-title">ğŸ¨ å®¢æˆ¿åˆ†æ</div>
<p><strong>æ•´ä½“è¡¨ç°ï¼š</strong>æè¿°</p>
<p class="highlight-good">âœ“ è¡¨ç°ä¼˜ç§€ï¼šåˆ—å‡ºè¡¨ç°å¥½çš„é¡¹ç›®åŠåŸå› </p>
<p class="highlight-bad">âœ— éœ€è¦æ”¹è¿›ï¼šåˆ—å‡ºè¡¨ç°å·®çš„é¡¹ç›®</p>
<div class="suggestion-item">ğŸ’¡ å»ºè®®ï¼šå…·ä½“æ”¹è¿›å»ºè®®</div>

<div class="section-title">ğŸ½ï¸ é¤é¥®åˆ†æ</div>
ï¼ˆåŒä¸Šæ ¼å¼ï¼‰

<div class="section-title">âš ï¸ é£é™©é¢„è­¦</div>
<div class="risk-item">ğŸ”´ é£é™©ç‚¹1ï¼šå…·ä½“é£é™©æè¿°</div>
<div class="risk-item">ğŸŸ¡ é£é™©ç‚¹2ï¼šå…·ä½“é£é™©æè¿°</div>

<div class="section-title">ğŸ“ˆ æœˆåº¦è¿›å±•</div>
<p>æœ¬æœˆç¬¬{day}å¤©ï¼Œæ—¶é—´è¿›åº¦{time_progress}%</p>
<p>å½“å‰ç´¯è®¡æ”¶å…¥é¢„æµ‹æœˆåº•å®Œæˆç‡ï¼šXX%</p>
<p class="highlight-warn">é¢„æµ‹åˆ†æï¼š...</p>

é‡è¦æé†’ï¼š
1. æ‰€æœ‰å®Œæˆç‡æ•°æ®å¿…é¡»ä½¿ç”¨æˆ‘æä¾›çš„æ•°æ®ï¼Œä¸è¦è‡ªå·±è®¡ç®—ï¼
2. æ•´ä½“å®Œæˆç‡æ˜¯{total_pct}%ï¼Œä¸æ˜¯å…¶ä»–æ•°å­—
3. åˆ†æè¦å…·ä½“åˆ°é¡¹ç›®åç§°`;

        const STATE = {
            currentData: null, historyIndex: [], historyData: {}, charts: {}, totalRooms: 260,
            webhookUrl: localStorage.getItem('nexus_webhook_url') || 'https://n8n-fzlhzvbn.ap-northeast-1.clawcloudrun.com/webhook/hotel-save',
            github: { owner: 'QIAN123-KIWI', repo: 'hotel-daily-reportV3', branch: 'main', dataPath: 'data' },
            qianwen: { apiKey: 'sk-d8f9d80c5d154e5fa8ce9413560ccfe8', model: 'qwen-max', endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions' },
            aiPrompt: localStorage.getItem('nexus_ai_prompt') || DEFAULT_AI_PROMPT,
            sidebarCollapsed: localStorage.getItem('nexus_sidebar_collapsed') === 'true'
        };

        // å·¥å…·å‡½æ•°
        function toggleSidebar() {
            const s = document.getElementById('sidebar'); s.classList.toggle('collapsed');
            STATE.sidebarCollapsed = s.classList.contains('collapsed');
            localStorage.setItem('nexus_sidebar_collapsed', STATE.sidebarCollapsed);
            setTimeout(() => Object.values(STATE.charts).forEach(c => c?.resize()), 250);
        }
        
        function showToast(m, t = 'info') { 
            const c = document.getElementById('toast-container'), e = document.createElement('div'); 
            e.className = `toast toast-${t}`; 
            e.innerHTML = `<i class="fa-solid ${t === 'success' ? 'fa-check-circle' : t === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i><span>${m}</span>`; 
            c.appendChild(e); 
            setTimeout(() => { e.style.opacity = '0'; setTimeout(() => e.remove(), 200); }, 3000); 
        }
        
        function openSettingsModal() { 
            document.getElementById('settings-webhook').value = STATE.webhookUrl; 
            document.getElementById('settings-github-repo').value = `${STATE.github.owner}/${STATE.github.repo}`; 
            document.getElementById('settings-ai-prompt').value = STATE.aiPrompt; 
            document.getElementById('settings-modal').classList.remove('hidden'); 
        }
        
        function openDeepDive() { document.getElementById('deep-modal').classList.remove('hidden'); switchDeepTab('room'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function resetPrompt() { document.getElementById('settings-ai-prompt').value = DEFAULT_AI_PROMPT; }
        
        function saveSettings() {
            STATE.webhookUrl = document.getElementById('settings-webhook').value.trim();
            const r = document.getElementById('settings-github-repo').value.trim().split('/');
            if (r.length === 2) { STATE.github.owner = r[0]; STATE.github.repo = r[1]; }
            STATE.aiPrompt = document.getElementById('settings-ai-prompt').value.trim() || DEFAULT_AI_PROMPT;
            localStorage.setItem('nexus_webhook_url', STATE.webhookUrl);
            localStorage.setItem('nexus_ai_prompt', STATE.aiPrompt);
            document.getElementById('inline-prompt').value = STATE.aiPrompt;
            closeModal('settings-modal'); 
            showToast('è®¾ç½®å·²ä¿å­˜', 'success'); 
            refreshFromGitHub();
        }
        
        // æç¤ºè¯é¢æ¿
        function togglePromptPanel() {
            const panel = document.getElementById('prompt-panel');
            const chevron = document.getElementById('prompt-chevron');
            panel.classList.toggle('collapsed');
            panel.classList.toggle('expanded');
            chevron.style.transform = panel.classList.contains('expanded') ? 'rotate(180deg)' : '';
            
            if (panel.classList.contains('expanded')) {
                document.getElementById('inline-prompt').value = STATE.aiPrompt;
            }
        }
        
        function resetInlinePrompt() {
            document.getElementById('inline-prompt').value = DEFAULT_AI_PROMPT;
        }
        
        function applyPromptAndAnalyze() {
            STATE.aiPrompt = document.getElementById('inline-prompt').value.trim() || DEFAULT_AI_PROMPT;
            localStorage.setItem('nexus_ai_prompt', STATE.aiPrompt);
            showToast('æç¤ºè¯å·²æ›´æ–°', 'success');
            generateAIAnalysis();
        }

        // äº‘ç«¯
        async function saveToGitHub() {
            if (!STATE.currentData) return showToast('è¯·å…ˆä¸Šä¼ æ•°æ®', 'error');
            const btn = document.getElementById('save-btn'); 
            btn.disabled = true; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>ä¿å­˜ä¸­...';
            try { 
                await fetch(STATE.webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(STATE.currentData) }); 
                showToast('æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯', 'success'); 
                setTimeout(refreshFromGitHub, 2000); 
            }
            catch { showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-1.5"></i>ä¿å­˜åˆ°äº‘ç«¯'; }
        }
        
        async function refreshFromGitHub() {
            try { 
                const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/index.json?t=${Date.now()}`); 
                if (!res.ok) throw new Error(); 
                STATE.historyIndex = await res.json(); 
                renderHistoryList(); 
                if (STATE.historyIndex.length) { 
                    const s = [...STATE.historyIndex].sort((a, b) => b.date.localeCompare(a.date)); 
                    await loadDayData(s[0].date); 
                } 
                await loadTrendData(); 
            } catch (e) { console.error(e); }
        }
        
        async function loadDayData(date) {
            if (STATE.historyData[date]) { 
                STATE.currentData = STATE.historyData[date]; 
                renderDashboard(STATE.currentData); 
                return; 
            }
            try { 
                const [y, m] = date.split('-'); 
                const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/${y}/${m}/${date}.json?t=${Date.now()}`); 
                if (!res.ok) throw new Error(); 
                const d = await res.json(); 
                STATE.historyData[date] = d; 
                STATE.currentData = d; 
                renderDashboard(d); 
                document.querySelectorAll('.history-item').forEach(el => el.classList.toggle('active', el.dataset.date === date)); 
                document.getElementById('save-btn').disabled = false; 
            } catch {}
        }
        
        async function loadTrendData() {
            const s = [...STATE.historyIndex].sort((a, b) => a.date.localeCompare(b.date)).slice(-30), td = [];
            for (const i of s) { 
                if (STATE.historyData[i.date]) td.push(STATE.historyData[i.date]); 
                else try { 
                    const [y, m] = i.date.split('-'); 
                    const res = await fetch(`https://raw.githubusercontent.com/${STATE.github.owner}/${STATE.github.repo}/${STATE.github.branch}/${STATE.github.dataPath}/${y}/${m}/${i.date}.json`); 
                    if (res.ok) { const d = await res.json(); STATE.historyData[i.date] = d; td.push(d); } 
                } catch {} 
            }
            renderTrendChart(td);
            renderOpsTrendChart(td);
        }

        // å†å²åˆ—è¡¨
        function renderHistoryList() {
            const c = document.getElementById('history-list'); 
            document.getElementById('history-count').innerText = STATE.historyIndex.length;
            if (!STATE.historyIndex.length) { 
                c.innerHTML = '<div class="text-center py-8 text-zinc-600 text-xs">æš‚æ— å†å²æ•°æ®</div>'; 
                return; 
            }
            const g = {}; 
            STATE.historyIndex.forEach(i => { const k = i.date.slice(0, 7); if (!g[k]) g[k] = []; g[k].push(i); });
            let h = ''; 
            Object.entries(g).sort((a, b) => b[0].localeCompare(a[0])).forEach(([m, items], idx) => {
                items.sort((a, b) => b.date.localeCompare(a.date));
                h += `<div class="mb-2">
                    <div onclick="toggleMonth(this)" class="flex justify-between p-2 rounded-lg cursor-pointer hover:bg-zinc-800/50 text-xs text-zinc-400 transition-colors">
                        <span><i class="fa-solid fa-chevron-right mr-2 transition-transform ${idx === 0 ? 'rotate-90' : ''}" style="font-size:8px"></i>${m}</span>
                        <span class="text-zinc-600 bg-zinc-800/50 px-1.5 rounded">${items.length}</span>
                    </div>
                    <div class="month-content ${idx === 0 ? 'expanded' : ''}">
                        ${items.map(i => `<div class="history-item flex justify-between" data-date="${i.date}" onclick="loadDayData('${i.date}')">
                            <span class="text-zinc-300">${i.date.slice(8)}æ—¥</span>
                            <span class="${(i.variance || 0) >= 0 ? 'text-green-400' : 'text-red-400'} font-mono text-xs">${(i.variance || 0) >= 0 ? '+' : ''}${((i.variance || 0) * 100).toFixed(1)}%</span>
                        </div>`).join('')}
                    </div>
                </div>`;
            }); 
            c.innerHTML = h;
        }
        
        function toggleMonth(h) { 
            h.nextElementSibling.classList.toggle('expanded'); 
            h.querySelector('i').classList.toggle('rotate-90'); 
        }

        // Excel è§£æ
        function handleFileUpload(e) {
            const f = e.target.files[0]; if (!f) return;
            const fn = f.name.replace(/\.(xlsx|xls|csv)$/i, ''); 
            let dateFromFn = null;
            const m1 = fn.match(/(\d{4})[-._](\d{1,2})[-._](\d{1,2})/); 
            if (m1) dateFromFn = `${m1[1]}-${m1[2].padStart(2,'0')}-${m1[3].padStart(2,'0')}`;
            else { 
                const m2 = fn.match(/(\d{1,2})[-._](\d{1,2})/); 
                if (m2) dateFromFn = `${new Date().getFullYear()}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; 
            }
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' }), 
                      rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }), 
                      parsed = parseExcelData(rows);
                if (dateFromFn) { 
                    parsed.date = dateFromFn; 
                    parsed.weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(dateFromFn).getDay()]; 
                }
                STATE.currentData = parsed; 
                renderDashboard(parsed); 
                document.getElementById('save-btn').disabled = false; 
                showToast(`å·²åŠ è½½ ${parsed.date} æ•°æ®`, 'success'); 
                generateAIAnalysis();
            };
            reader.readAsArrayBuffer(f); 
            e.target.value = '';
        }

        function parseExcelData(rows) {
            let d = { 
                date: new Date().toISOString().split('T')[0], 
                weekday: '', 
                rows: [], 
                roomsSold: 0, 
                roomsBud: 0, 
                occupancy: 0, 
                occBud: 0, 
                adr: 0, 
                adrBud: 0, 
                revpar: 0, 
                revparBud: 0, 
                totals: {} 
            };
            const num = v => v ? parseFloat(String(v).replace(/[Â¥,%]/g, '')) || 0 : 0;
            
            rows.forEach(r => {
                if (!r[0]) return; 
                const n = String(r[0]).trim();
                
                if (n.includes('Date') || n.includes('æ—¥æœŸ')) { 
                    const m = r.join(' ').match(/(\d{1,2})\/(\w+)\/(\d{4})/); 
                    if (m) { 
                        const mm = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'}; 
                        d.date = `${m[3]}-${mm[m[2]]||m[2]}-${m[1].padStart(2,'0')}`; 
                        d.weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(d.date).getDay()]; 
                    } 
                }
                
                if (n.includes('Total room Revenue') || n.includes('æ€»æˆ¿æ”¶å…¥')) d.totals.room = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('F&B Total') || n.includes('é¤é¥®æ”¶å…¥åˆè®¡')) d.totals.fb = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('Total Hotel Revenue') || n.includes('é…’åº—æ”¶å…¥åˆè®¡')) d.totals.hotel = { act: num(r[6]), bud: num(r[7]) };
                if (n.includes('Total Other Operating') || n.includes('å…¶ä»–ç»è¥æ”¶å…¥åˆè®¡')) d.totals.other = { act: num(r[6]), bud: num(r[7]) };
                
                if (n.includes('Occupied Rooms') || n.includes('å·²å‡ºç§Ÿæˆ¿æ•°')) { d.roomsSold = num(r[6]); d.roomsBud = num(r[7]); }
                if (n.includes('Paid Occupancy') || n.includes('å®¢æˆ¿ä½æˆ¿ç‡')) { d.occupancy = num(r[6]); d.occBud = num(r[7]); }
                if (n.includes('Paid Average Room Rate') || (n.includes('å¹³å‡æˆ¿ä»·') && !n.includes('å¯å‡ºç§Ÿ') && !n.includes('Rev'))) { d.adr = num(r[6]); d.adrBud = num(r[7]); }
                if (n.includes('Rev Par') || n.includes('å¯å‡ºç§Ÿ')) { d.revpar = num(r[6]); d.revparBud = num(r[7]); }
                
                if (r.length >= 7 && num(r[6]) !== 0) {
                    let type = 'Other';
                    if (/Rate|Negotiated|Tour|Discount|Marketing|Permanent|Surcharge|æœåŠ¡è´¹|Convention|SMRF|Meeting|Consortia|æˆ¿è´¹/.test(n)) type = 'Room';
                    else if (/Kok|Alley|Brasserie|Bar|Ville|Service|Mini|è”šæ™¯|ç™¾å‘³|å»Šå§|ç¾¿åº­|Ling|Wai|Peacock|Long|Salon|é¤/.test(n)) type = 'F&B';
                    else if (/Banquet|å®´ä¼š|Rental|ä¼šè®®/.test(n)) type = 'Banquet';
                    d.rows.push({ name: n, type, actual: num(r[6]), budget: num(r[7]) });
                }
            });
            return d;
        }

        // Dashboard
        function renderDashboard(d) {
            let room = d.totals.room || { act: 0, bud: 0 };
            let fb = d.totals.fb || { act: 0, bud: 0 };
            let other = d.totals.other || { act: 0, bud: 0 };
            let grand = d.totals.hotel || { act: 0, bud: 0 };
            
            if (d.totals.hotel && d.totals.room && d.totals.fb) { 
                other.act = grand.act - room.act - fb.act; 
                other.bud = grand.bud - room.bud - fb.bud; 
            }
            
            if (STATE.currentData?.date === d.date) {
                STATE.currentData.totals = { room, fb, other, hotel: grand };
            }

            document.getElementById('current-date').innerText = d.date + ' ' + (d.weekday || '');
            document.getElementById('data-status').innerText = 'å·²åŠ è½½'; 
            document.getElementById('data-status').className = 'tag tag-green';

            const fmt = n => 'Â¥' + Math.floor(n).toLocaleString();
            
            document.getElementById('kpi-revenue').innerText = fmt(grand.act); 
            document.getElementById('kpi-revenue-bud').innerText = fmt(grand.bud);
            const v = grand.bud > 0 ? (grand.act / grand.bud - 1) : 0; 
            const vt = document.getElementById('kpi-revenue-tag'); 
            vt.innerText = (v >= 0 ? '+' : '') + (v * 100).toFixed(1) + '%'; 
            vt.className = `tag ${v >= 0 ? 'tag-green' : 'tag-red'}`;

            document.getElementById('kpi-occ').innerText = ((d.occupancy || 0) * 100).toFixed(1) + '%';
            document.getElementById('kpi-sold').innerText = d.roomsSold;
            document.getElementById('kpi-adr').innerText = 'Â¥' + Math.floor(d.adr || 0);
            document.getElementById('kpi-adr-bud').innerText = 'Â¥' + Math.floor(d.adrBud || 0);
            document.getElementById('kpi-revpar').innerText = 'Â¥' + Math.floor(d.revpar || 0);
            document.getElementById('kpi-revpar-bud').innerText = 'Â¥' + Math.floor(d.revparBud || 0);

            const depts = [
                { name: 'å®¢æˆ¿æ”¶å…¥', act: room.act, bud: room.bud, icon: 'ğŸ¨' },
                { name: 'é¤é¥®æ”¶å…¥', act: fb.act, bud: fb.bud, icon: 'ğŸ½ï¸' },
                { name: 'å…¶ä»–æ”¶å…¥', act: other.act, bud: other.bud, icon: 'ğŸ“¦' },
                { name: 'é…’åº—åˆè®¡', act: grand.act, bud: grand.bud, icon: 'ğŸ¢' }
            ];
            
            document.getElementById('dept-table-body').innerHTML = depts.map(dep => {
                const diff = dep.act - dep.bud;
                const pct = dep.bud > 0 ? (dep.act / dep.bud * 100) : 100;
                return `<tr class="${dep.name === 'é…’åº—åˆè®¡' ? 'bg-zinc-800/30 font-medium' : ''}">
                    <td class="text-zinc-300">${dep.icon} ${dep.name}</td>
                    <td class="font-mono text-white">Â¥${Math.floor(dep.act).toLocaleString()}</td>
                    <td class="text-zinc-500 font-mono">Â¥${Math.floor(dep.bud).toLocaleString()}</td>
                    <td class="${diff >= 0 ? 'text-green-400' : 'text-red-400'} font-mono">${diff >= 0 ? '+' : ''}${(diff/10000).toFixed(1)}ä¸‡</td>
                    <td class="${pct >= 100 ? 'text-green-400' : pct >= 90 ? 'text-amber-400' : 'text-red-400'} font-medium">${pct.toFixed(1)}%</td>
                </tr>`;
            }).join('');

            renderMainChart(depts.slice(0, 3));
            renderPieChart(depts.slice(0, 3));
        }

        function renderMainChart(depts) {
            const el = document.getElementById('main-chart');
            if (STATE.charts.main) STATE.charts.main.dispose();
            const chart = echarts.init(el, 'dark');
            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                legend: { 
                    data: ['å®é™…', 'é¢„ç®—'], 
                    bottom: 0, 
                    textStyle: { color: '#71717a', fontSize: 10 } 
                },
                grid: { left: 10, right: 10, top: 10, bottom: 40, containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: depts.map(d => d.name), 
                    axisLabel: { fontSize: 10, color: '#a1a1aa' },
                    axisLine: { lineStyle: { color: '#27272a' } }
                },
                yAxis: { 
                    type: 'value', 
                    axisLabel: { fontSize: 9, formatter: v => (v/10000) + 'w' },
                    splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } }
                },
                series: [
                    { 
                        name: 'å®é™…', 
                        type: 'bar', 
                        data: depts.map(d => d.act), 
                        itemStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#3b82f6' },
                                { offset: 1, color: '#1d4ed8' }
                            ]),
                            borderRadius: [4, 4, 0, 0] 
                        },
                        barWidth: 20
                    },
                    { 
                        name: 'é¢„ç®—', 
                        type: 'bar', 
                        data: depts.map(d => d.bud), 
                        itemStyle: { color: '#3f3f46', borderRadius: [4, 4, 0, 0] },
                        barWidth: 20
                    }
                ]
            });
            STATE.charts.main = chart;
        }

        function renderPieChart(depts) {
            const el = document.getElementById('pie-chart');
            if (STATE.charts.pie) STATE.charts.pie.dispose();
            const chart = echarts.init(el, 'dark');
            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: Â¥{c} ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 6,
                        borderColor: '#16161a',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        position: 'outside',
                        fontSize: 10,
                        color: '#a1a1aa',
                        formatter: '{b}\n{d}%'
                    },
                    labelLine: {
                        length: 10,
                        length2: 5
                    },
                    data: [
                        { value: depts[0].act, name: 'å®¢æˆ¿', itemStyle: { color: '#3b82f6' } },
                        { value: depts[1].act, name: 'é¤é¥®', itemStyle: { color: '#22c55e' } },
                        { value: depts[2].act, name: 'å…¶ä»–', itemStyle: { color: '#f59e0b' } }
                    ]
                }]
            });
            STATE.charts.pie = chart;
        }

        // è¥æ”¶è¶‹åŠ¿å›¾
        function renderTrendChart(data) {
            const el = document.getElementById('trend-chart');
            if (STATE.charts.trend) STATE.charts.trend.dispose();
            if (!data.length) return;
            
            const chart = echarts.init(el, 'dark');
            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { 
                    trigger: 'axis',
                    formatter: function(params) {
                        let tip = params[0].name + '<br/>';
                        params.forEach(p => {
                            tip += `${p.marker} ${p.seriesName}: Â¥${(p.value/10000).toFixed(1)}ä¸‡<br/>`;
                        });
                        return tip;
                    }
                },
                legend: { 
                    data: ['å®é™…è¥æ”¶', 'é¢„ç®—'], 
                    bottom: 0, 
                    textStyle: { color: '#71717a', fontSize: 10 } 
                },
                grid: { left: 10, right: 10, top: 10, bottom: 40, containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: data.map(d => d.date.slice(5)),
                    axisLabel: { fontSize: 9, color: '#71717a', rotate: 30 },
                    axisLine: { lineStyle: { color: '#27272a' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { fontSize: 9, formatter: v => (v/10000) + 'w' },
                    splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } }
                },
                series: [
                    { 
                        name: 'å®é™…è¥æ”¶', 
                        type: 'line', 
                        data: data.map(d => d.totals?.hotel?.act || 0),
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#3b82f6', width: 2 },
                        itemStyle: { color: '#3b82f6' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                            ])
                        }
                    },
                    { 
                        name: 'é¢„ç®—', 
                        type: 'line', 
                        data: data.map(d => d.totals?.hotel?.bud || 0),
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { color: '#71717a', width: 1, type: 'dashed' }
                    }
                ]
            });
            STATE.charts.trend = chart;
        }

        // è¿è¥æŒ‡æ ‡è¶‹åŠ¿å›¾ï¼ˆRevPARã€ADRã€å…¥ä½ç‡ï¼‰
        function renderOpsTrendChart(data) {
            const el = document.getElementById('ops-trend-chart');
            if (STATE.charts.opsTrend) STATE.charts.opsTrend.dispose();
            if (!data.length) return;
            
            const chart = echarts.init(el, 'dark');
            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { 
                    trigger: 'axis',
                    formatter: function(params) {
                        let tip = params[0].name + '<br/>';
                        params.forEach(p => {
                            if (p.seriesName === 'å…¥ä½ç‡') {
                                tip += `${p.marker} ${p.seriesName}: ${p.value}%<br/>`;
                            } else {
                                tip += `${p.marker} ${p.seriesName}: Â¥${p.value}<br/>`;
                            }
                        });
                        return tip;
                    }
                },
                legend: { 
                    data: ['RevPAR', 'ADR', 'å…¥ä½ç‡'], 
                    bottom: 0, 
                    textStyle: { color: '#71717a', fontSize: 10 } 
                },
                grid: { left: 10, right: 40, top: 10, bottom: 40, containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: data.map(d => d.date.slice(5)),
                    axisLabel: { fontSize: 9, color: '#71717a', rotate: 30 },
                    axisLine: { lineStyle: { color: '#27272a' } }
                },
                yAxis: [
                    { 
                        type: 'value',
                        name: 'æˆ¿ä»·',
                        position: 'left',
                        axisLabel: { fontSize: 9, formatter: v => 'Â¥' + v },
                        splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } }
                    },
                    {
                        type: 'value',
                        name: 'å…¥ä½ç‡',
                        position: 'right',
                        min: 0,
                        max: 100,
                        axisLabel: { fontSize: 9, formatter: v => v + '%' },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    { 
                        name: 'RevPAR', 
                        type: 'line', 
                        yAxisIndex: 0,
                        data: data.map(d => Math.floor(d.revpar || 0)),
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#a855f7', width: 2 },
                        itemStyle: { color: '#a855f7' }
                    },
                    { 
                        name: 'ADR', 
                        type: 'line', 
                        yAxisIndex: 0,
                        data: data.map(d => Math.floor(d.adr || 0)),
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#f59e0b', width: 2 },
                        itemStyle: { color: '#f59e0b' }
                    },
                    { 
                        name: 'å…¥ä½ç‡', 
                        type: 'line', 
                        yAxisIndex: 1,
                        data: data.map(d => ((d.occupancy || 0) * 100).toFixed(1)),
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#22c55e', width: 2 },
                        itemStyle: { color: '#22c55e' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(34, 197, 94, 0.2)' },
                                { offset: 1, color: 'rgba(34, 197, 94, 0)' }
                            ])
                        }
                    }
                ]
            });
            STATE.charts.opsTrend = chart;
        }

        // AI åˆ†æ - ä¿®å¤æ•°æ®åŒ¹é…é—®é¢˜
        async function generateAIAnalysis() {
            if (!STATE.currentData) return;
            const container = document.getElementById('ai-analysis');
            const statusDot = document.getElementById('ai-status-dot');
            
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="ai-loading"><div class="spinner"></div></div>
                    <p class="text-zinc-500 text-xs mt-3">AI æ­£åœ¨åˆ†ææ•°æ®...</p>
                </div>
            `;
            statusDot.classList.add('active');
            
            try {
                const d = STATE.currentData;
                const dayNum = parseInt(d.date.split('-')[2]);
                const daysInMonth = new Date(d.date.split('-')[0], d.date.split('-')[1], 0).getDate();
                const timeProgress = ((dayNum / daysInMonth) * 100).toFixed(1);
                
                const room = d.totals?.room || { act: 0, bud: 0 };
                const fb = d.totals?.fb || { act: 0, bud: 0 };
                const other = d.totals?.other || { act: 0, bud: 0 };
                const hotel = d.totals?.hotel || { act: 0, bud: 0 };
                
                const roomDiff = room.act - room.bud;
                const fbDiff = fb.act - fb.bud;
                const otherDiff = other.act - other.bud;
                const hotelDiff = hotel.act - hotel.bud;
                
                // è®¡ç®—å®Œæˆç‡ - ä¿®å¤æ•°æ®åŒ¹é…é—®é¢˜
                const roomPct = room.bud > 0 ? (room.act / room.bud * 100).toFixed(1) : '100';
                const fbPct = fb.bud > 0 ? (fb.act / fb.bud * 100).toFixed(1) : '100';
                const otherPct = other.bud > 0 ? (other.act / other.bud * 100).toFixed(1) : '100';
                const totalPct = hotel.bud > 0 ? (hotel.act / hotel.bud * 100).toFixed(1) : '100';
                
                const fmtDiff = v => (v >= 0 ? '+' : '') + (v / 10000).toFixed(1) + 'ä¸‡';
                
                const roomRows = d.rows.filter(r => r.type === 'Room').sort((a, b) => b.actual - a.actual);
                const fbRows = d.rows.filter(r => r.type === 'F&B' || r.type === 'Banquet').sort((a, b) => b.actual - a.actual);
                
                const roomDetails = roomRows.map(r => {
                    const pct = r.budget > 0 ? (r.actual / r.budget * 100).toFixed(0) : 100;
                    return `${r.name}: å®é™…Â¥${r.actual.toLocaleString()} / é¢„ç®—Â¥${r.budget.toLocaleString()} (å®Œæˆ${pct}%)`;
                }).join('\n');
                
                const fbDetails = fbRows.map(r => {
                    const pct = r.budget > 0 ? (r.actual / r.budget * 100).toFixed(0) : 100;
                    return `${r.name}: å®é™…Â¥${r.actual.toLocaleString()} / é¢„ç®—Â¥${r.budget.toLocaleString()} (å®Œæˆ${pct}%)`;
                }).join('\n');
                
                const occPct = ((d.occupancy || 0) * 100).toFixed(1);
                const occBudPct = ((d.occBud || 0) * 100).toFixed(1);
                
                // æ›¿æ¢æ‰€æœ‰å ä½ç¬¦
                const prompt = STATE.aiPrompt
                    .replace(/{date}/g, d.date)
                    .replace(/{day}/g, dayNum)
                    .replace(/{time_progress}/g, timeProgress)
                    .replace(/{profit_status}/g, hotelDiff >= 0 ? 'ç›ˆä½™' : 'äºæŸ')
                    .replace(/{profit_amount}/g, Math.abs(hotelDiff / 10000).toFixed(1))
                    .replace(/{total_pct}/g, totalPct)
                    .replace(/{total_pct_bar}/g, Math.min(parseFloat(totalPct), 150))
                    .replace(/{total_color}/g, parseFloat(totalPct) >= 100 ? '#22c55e' : parseFloat(totalPct) >= 90 ? '#f59e0b' : '#ef4444')
                    .replace(/{room_act}/g, (room.act / 10000).toFixed(1))
                    .replace(/{room_bud}/g, (room.bud / 10000).toFixed(1))
                    .replace(/{room_pct}/g, roomPct)
                    .replace(/{room_diff}/g, fmtDiff(roomDiff))
                    .replace(/{room_status}/g, roomDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{room_class}/g, roomDiff >= 0 ? 'highlight-good' : 'highlight-bad')
                    .replace(/{fb_act}/g, (fb.act / 10000).toFixed(1))
                    .replace(/{fb_bud}/g, (fb.bud / 10000).toFixed(1))
                    .replace(/{fb_pct}/g, fbPct)
                    .replace(/{fb_diff}/g, fmtDiff(fbDiff))
                    .replace(/{fb_status}/g, fbDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{fb_class}/g, fbDiff >= 0 ? 'highlight-good' : 'highlight-bad')
                    .replace(/{other_act}/g, (other.act / 10000).toFixed(1))
                    .replace(/{other_bud}/g, (other.bud / 10000).toFixed(1))
                    .replace(/{other_pct}/g, otherPct)
                    .replace(/{other_diff}/g, fmtDiff(otherDiff))
                    .replace(/{other_status}/g, otherDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£')
                    .replace(/{other_class}/g, otherDiff >= 0 ? 'highlight-good' : 'highlight-bad')
                    .replace(/{occupancy}/g, occPct)
                    .replace(/{occ_bud}/g, occBudPct)
                    .replace(/{occ_status}/g, parseFloat(occPct) >= parseFloat(occBudPct) ? 'è¾¾æ ‡' : 'æœªè¾¾æ ‡')
                    .replace(/{adr}/g, Math.floor(d.adr || 0))
                    .replace(/{revpar}/g, Math.floor(d.revpar || 0))
                    .replace(/{roomsSold}/g, d.roomsSold)
                    .replace(/{rooms_bud}/g, Math.floor(d.roomsBud || 0))
                    .replace(/{details}/g, `ã€å®¢æˆ¿æ”¶å…¥æ˜ç»†ã€‘\n${roomDetails}\n\nã€é¤é¥®æ”¶å…¥æ˜ç»†ã€‘\n${fbDetails}`);

                const res = await fetch(STATE.qianwen.endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${STATE.qianwen.apiKey}` },
                    body: JSON.stringify({ 
                        model: STATE.qianwen.model, 
                        messages: [{ role: 'user', content: prompt }], 
                        temperature: 0.5, 
                        max_tokens: 2000 
                    })
                });
                
                if (!res.ok) throw new Error();
                const result = await res.json();
                let aiContent = result.choices[0].message.content;
                aiContent = aiContent.replace(/```html\n?/gi, '').replace(/```\n?/g, '').replace(/#{1,3}\s/g, '').replace(/\*\*/g, '').trim();
                container.innerHTML = aiContent;
                document.getElementById('ai-update-time').innerText = new Date().toLocaleString('zh-CN');
                STATE.currentData.aiAnalysis = aiContent;
                statusDot.classList.remove('active');
            } catch (e) {
                console.error(e);
                statusDot.classList.remove('active');
                renderBasicAnalysis();
            }
        }

        function renderBasicAnalysis() {
            if (!STATE.currentData) return;
            const d = STATE.currentData, c = document.getElementById('ai-analysis');
            const hotel = d.totals?.hotel || { act: 0, bud: 0 };
            const room = d.totals?.room || { act: 0, bud: 0 };
            const fb = d.totals?.fb || { act: 0, bud: 0 };
            const other = d.totals?.other || { act: 0, bud: 0 };
            
            const hotelDiff = hotel.act - hotel.bud;
            const roomDiff = room.act - room.bud;
            const fbDiff = fb.act - fb.bud;
            const otherDiff = other.act - other.bud;
            const fmtD = v => (v >= 0 ? '+' : '') + (v / 10000).toFixed(1) + 'ä¸‡';
            
            const roomPct = room.bud > 0 ? (room.act / room.bud * 100).toFixed(1) : 100;
            const fbPct = fb.bud > 0 ? (fb.act / fb.bud * 100).toFixed(1) : 100;
            const otherPct = other.bud > 0 ? (other.act / other.bud * 100).toFixed(1) : 100;
            const hotelPct = hotel.bud > 0 ? (hotel.act / hotel.bud * 100).toFixed(1) : 100;
            
            const goodItems = d.rows.filter(r => r.budget > 1000 && r.actual / r.budget >= 1).slice(0, 5);
            const badItems = d.rows.filter(r => r.budget > 1000 && r.actual / r.budget < 0.8).slice(0, 5);
            
            c.innerHTML = `
                <div class="section-title">ğŸ“Š é¢„ç®—æ‰§è¡Œæ€»è§ˆ</div>
                <p><strong>æ•´ä½“å®Œæˆç‡ï¼š${hotelPct}%</strong></p>
                <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(hotelPct, 150)}%;background:${hotelPct >= 100 ? '#22c55e' : hotelPct >= 90 ? '#f59e0b' : '#ef4444'}"></div></div>
                <div class="data-row"><span>å®¢æˆ¿æ”¶å…¥</span><span class="${roomDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">å®Œæˆ${roomPct}%ï¼ˆ${fmtD(roomDiff)}ï¼‰</span></div>
                <div class="data-row"><span>é¤é¥®æ”¶å…¥</span><span class="${fbDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">å®Œæˆ${fbPct}%ï¼ˆ${fmtD(fbDiff)}ï¼‰</span></div>
                <div class="data-row"><span>å…¶ä»–æ”¶å…¥</span><span class="${otherDiff >= 0 ? 'highlight-good' : 'highlight-bad'}">å®Œæˆ${otherPct}%ï¼ˆ${fmtD(otherDiff)}ï¼‰</span></div>
                
                <div class="section-title">ğŸ¨ è¿è¥æŒ‡æ ‡</div>
                <p><strong>å…¥ä½ç‡ï¼š</strong>${((d.occupancy||0)*100).toFixed(1)}%ï¼ˆé¢„ç®—${((d.occBud||0)*100).toFixed(1)}%ï¼‰</p>
                <p><strong>å”®æˆ¿ï¼š</strong>${d.roomsSold}é—´ï¼ˆé¢„ç®—${Math.floor(d.roomsBud || 0)}é—´ï¼‰</p>
                <p><strong>æˆ¿ä»·æ°´å¹³ï¼š</strong>å¹³å‡æˆ¿ä»· Â¥${Math.floor(d.adr)}ï¼Œæ¯æˆ¿æ”¶ç›Š Â¥${Math.floor(d.revpar)}</p>
                
                ${goodItems.length > 0 ? `<div class="section-title">âœ… è¡¨ç°ä¼˜ç§€</div><p class="highlight-good">${goodItems.map(r => r.name.split(' ')[0] + '(' + (r.actual/r.budget*100).toFixed(0) + '%)').join('ã€')}</p>` : ''}
                ${badItems.length > 0 ? `<div class="section-title">âš ï¸ éœ€è¦å…³æ³¨</div><p class="highlight-bad">${badItems.map(r => r.name.split(' ')[0] + '(' + (r.actual/r.budget*100).toFixed(0) + '%)').join('ã€')}</p>` : ''}
                
                <div class="risk-item">
                    <strong>æç¤ºï¼š</strong>AIåˆ†ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²æ˜¾ç¤ºåŸºç¡€æ•°æ®åˆ†æã€‚
                </div>
            `;
            document.getElementById('ai-update-time').innerText = new Date().toLocaleString('zh-CN') + ' (åŸºç¡€åˆ†æ)';
        }

        // æ·±åº¦åˆ†æ - ä¿®å¤ä¸­æ–‡æ˜¾ç¤º
        function switchDeepTab(tab) {
            ['room', 'fb', 'other'].forEach(t => { 
                const b = document.getElementById(`deep-tab-${t}`); 
                b.classList.toggle('bg-zinc-700', t === tab); 
                b.classList.toggle('text-white', t === tab); 
                b.classList.toggle('text-zinc-400', t !== tab); 
            });
            if (!STATE.currentData) return;
            
            const typeMap = { room: ['Room'], fb: ['F&B', 'Banquet'], other: ['Other'] };
            const nameMap = { room: 'å®¢æˆ¿æ”¶å…¥', fb: 'é¤é¥®æ”¶å…¥', other: 'å…¶ä»–æ”¶å…¥' };
            const rows = STATE.currentData.rows.filter(r => typeMap[tab].includes(r.type)).sort((a, b) => b.actual - a.actual);
            
            // è¡¨å¤´å…¨ä¸­æ–‡
            document.getElementById('deep-table-head').innerHTML = `<tr><th>é¡¹ç›®åç§°</th><th>å®é™…æ”¶å…¥</th><th>é¢„ç®—é‡‘é¢</th><th>å·®é¢</th><th>å®Œæˆç‡</th></tr>`;
            document.getElementById('deep-table-body').innerHTML = rows.map(r => { 
                const diff = r.actual - r.budget, p = r.budget > 0 ? (r.actual / r.budget * 100) : 100; 
                return `<tr>
                    <td class="text-zinc-300">${r.name}</td>
                    <td class="font-mono text-white">Â¥${r.actual.toLocaleString()}</td>
                    <td class="text-zinc-500 font-mono">Â¥${r.budget.toLocaleString()}</td>
                    <td class="${diff >= 0 ? 'text-green-400' : 'text-red-400'} font-mono">${diff >= 0 ? '+' : ''}${Math.floor(diff).toLocaleString()}</td>
                    <td class="${p >= 100 ? 'text-green-400' : p >= 80 ? 'text-amber-400' : 'text-red-400'} font-medium">${p.toFixed(0)}%</td>
                </tr>`; 
            }).join('');
            
            const el = document.getElementById('deep-chart'); 
            if (STATE.charts.deep) STATE.charts.deep.dispose();
            const chart = echarts.init(el, 'dark'), top = rows.slice(0, 10);
            chart.setOption({ 
                backgroundColor: 'transparent', 
                tooltip: { trigger: 'axis' }, 
                legend: { data: ['å®é™…æ”¶å…¥', 'é¢„ç®—é‡‘é¢'], bottom: 0, textStyle: { color: '#71717a', fontSize: 10 } }, 
                grid: { left: 10, right: 10, top: 10, bottom: 50, containLabel: true }, 
                xAxis: { type: 'category', data: top.map(r => r.name.split(' ')[0].slice(0, 8)), axisLabel: { rotate: 30, fontSize: 9, color: '#a1a1aa' } }, 
                yAxis: { type: 'value', axisLabel: { fontSize: 9 }, splitLine: { lineStyle: { color: '#27272a', type: 'dashed' } } }, 
                series: [
                    { name: 'å®é™…æ”¶å…¥', type: 'bar', data: top.map(r => r.actual), itemStyle: { color: '#3b82f6', borderRadius: [4, 4, 0, 0] }, barWidth: 14 }, 
                    { name: 'é¢„ç®—é‡‘é¢', type: 'bar', data: top.map(r => r.budget), itemStyle: { color: '#3f3f46', borderRadius: [4, 4, 0, 0] }, barWidth: 14 }
                ] 
            });
            STATE.charts.deep = chart;
            
            // åˆ†æè¡¨ç°å¥½å’Œå·®çš„é¡¹ç›®
            const good = rows.filter(r => r.budget > 1000 && r.actual / r.budget >= 1);
            const bad = rows.filter(r => r.budget > 1000 && r.actual / r.budget < 0.8);
            const totalAct = rows.reduce((s, r) => s + r.actual, 0);
            const totalBud = rows.reduce((s, r) => s + r.budget, 0);
            const totalPct = totalBud > 0 ? (totalAct / totalBud * 100).toFixed(1) : 100;
            const totalDiff = totalAct - totalBud;
            
            // æ‘˜è¦å…¨éƒ¨ç”¨ä¸­æ–‡
            document.getElementById('deep-summary-content').innerHTML = `
                <p style="margin-bottom:12px;">
                    <strong>${nameMap[tab]}æ•´ä½“æƒ…å†µï¼š</strong>
                    å®Œæˆç‡ <span class="${parseFloat(totalPct) >= 100 ? 'good' : 'bad'}" style="font-size:16px;font-weight:bold;">${totalPct}%</span>
                </p>
                <p>
                    å®é™…æ”¶å…¥ï¼š<strong>Â¥${(totalAct/10000).toFixed(1)}ä¸‡</strong>ã€€|ã€€
                    é¢„ç®—é‡‘é¢ï¼š<strong>Â¥${(totalBud/10000).toFixed(1)}ä¸‡</strong>ã€€|ã€€
                    ${totalDiff >= 0 ? 'è¶…é¢' : 'ç¼ºå£'}ï¼š<span class="${totalDiff >= 0 ? 'good' : 'bad'}"><strong>${Math.abs(totalDiff/10000).toFixed(1)}ä¸‡</strong></span>
                </p>
                
                ${good.length > 0 ? `
                <div style="margin-top:16px;padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;">
                    <p style="margin-bottom:8px;"><span class="good" style="font-weight:bold;">âœ“ è¡¨ç°ä¼˜ç§€ï¼ˆ${good.length}ä¸ªé¡¹ç›®ï¼‰</span></p>
                    <p style="font-size:11px;line-height:1.8;">${good.slice(0,8).map(r => {
                        const pct = (r.actual/r.budget*100).toFixed(0);
                        return `<span style="display:inline-block;background:#1a1a1f;padding:2px 8px;border-radius:4px;margin:2px 4px 2px 0;">
                            ${r.name.split(' ')[0]} <span class="good">${pct}%</span>
                        </span>`;
                    }).join('')}</p>
                </div>` : '<p style="margin-top:12px;color:#71717a;">æš‚æ— è¶…é¢å®Œæˆçš„é¡¹ç›®</p>'}
                
                ${bad.length > 0 ? `
                <div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;">
                    <p style="margin-bottom:8px;"><span class="bad" style="font-weight:bold;">âœ— éœ€è¦å…³æ³¨ï¼ˆ${bad.length}ä¸ªé¡¹ç›®æœªè¾¾æ ‡ï¼Œå®Œæˆç‡ä½äº80%ï¼‰</span></p>
                    <p style="font-size:11px;line-height:1.8;">${bad.slice(0,8).map(r => {
                        const pct = (r.actual/r.budget*100).toFixed(0);
                        return `<span style="display:inline-block;background:#1a1a1f;padding:2px 8px;border-radius:4px;margin:2px 4px 2px 0;">
                            ${r.name.split(' ')[0]} <span class="bad">${pct}%</span>
                        </span>`;
                    }).join('')}</p>
                </div>` : ''}
            `;
        }

        window.addEventListener('resize', () => Object.values(STATE.charts).forEach(c => c?.resize()));
        document.addEventListener('DOMContentLoaded', () => { 
            if (STATE.sidebarCollapsed) document.getElementById('sidebar').classList.add('collapsed'); 
            document.getElementById('inline-prompt').value = STATE.aiPrompt;
            refreshFromGitHub(); 
        });
    </script>
</body>
</html>
